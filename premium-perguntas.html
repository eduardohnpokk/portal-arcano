<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Consultas Sagradas</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --card-bg: #0a0a0a; --success: #2e7d32; --pending: #ff9800; }
        
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; line-height: 1.8; }
        
        /* LOADING */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { font-size: 4em; color: var(--gold); animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CONTAINER */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px 20px; }
        
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-back { cursor: pointer; color: #666; text-transform: uppercase; font-size: 0.8em; letter-spacing: 2px; border-bottom: 1px solid transparent; transition:0.3s; }
        .btn-back:hover { color: var(--gold); border-color: var(--gold); }
        
        /* HEADER */
        .page-header { text-align: center; margin-bottom: 50px; }
        .page-title { font-family: 'Cinzel'; color: var(--gold); font-size: 2.8em; margin: 0; text-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .page-sub { color: #888; font-size: 1.1em; max-width: 700px; margin: 15px auto 0 auto; }

        /* GRID DOS ORÁCULOS */
        .oracles-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 60px; }
        
        .oracle-card { 
            background: rgba(20, 20, 20, 0.6); border: 1px solid #333; padding: 30px; 
            border-radius: 8px; transition: 0.3s; border-top: 3px solid transparent;
            display: flex; flex-direction: column;
        }
        .oracle-card:hover { border-top-color: var(--gold); background: rgba(30, 30, 30, 0.8); transform: translateY(-5px); }
        
        .oracle-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .oracle-icon { font-size: 2.2em; color: var(--gold); }
        .oracle-name { font-family: 'Cinzel'; color: #fff; font-size: 1.4em; }
        
        .oracle-desc { font-size: 1em; color: #ccc; text-align: justify; flex-grow: 1; margin-bottom: 15px; }
        
        .oracle-time { 
            background: rgba(212,175,55,0.1); color: var(--gold); padding: 5px 10px; 
            border-radius: 4px; font-size: 0.85em; display: inline-block; font-family: 'Cinzel';
            border: 1px solid #333; width: fit-content;
        }

        /* FORMULÁRIO */
        .ritual-form {
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            border: 2px solid var(--gold); border-radius: 8px; padding: 50px; 
            box-shadow: 0 0 60px rgba(212,175,55,0.15); position: relative; margin-bottom: 60px;
        }

        .counter-badge {
            position: absolute; top: 20px; right: 20px;
            background: #111; border: 1px solid var(--gold); color: var(--gold);
            padding: 8px 20px; border-radius: 30px; font-family: 'Cinzel'; font-size: 0.9em;
        }

        .form-label { display: block; color: var(--gold); font-family: 'Cinzel'; font-size: 1.2em; margin-bottom: 15px; margin-top: 25px; }
        
        .styled-select, .styled-textarea {
            width: 100%; background: #0a0a0a; border: 1px solid #333; color: #fff; 
            padding: 15px; font-family: 'Cormorant Garamond', serif; font-size: 1.1em; 
            border-radius: 4px; box-sizing: border-box; resize: vertical; transition: 0.3s;
        }
        .styled-select:focus, .styled-textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 10px rgba(212,175,55,0.2); }

        .btn-send {
            background: var(--gold); color: #000; border: none; padding: 18px 40px; 
            font-family: 'Cinzel'; font-size: 1.3em; font-weight: bold; cursor: pointer; 
            border-radius: 4px; transition: 0.3s; width: 100%; margin-top: 30px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .btn-send:hover { background: #e6c256; box-shadow: 0 0 30px rgba(212,175,55,0.4); }
        .btn-send:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        .dynamic-time-info {
            text-align: center; margin-top: 20px; color: #888; font-size: 1em; font-style: italic;
        }
        .highlight-time { color: var(--gold); font-weight: bold; }

        /* HISTÓRICO DE PEDIDOS */
        .history-section { border-top: 1px solid #333; padding-top: 40px; }
        .history-title { font-family: 'Cinzel'; color: var(--gold); font-size: 2em; margin-bottom: 30px; text-align: center; }
        
        .history-list { display: flex; flex-direction: column; gap: 20px; }
        .history-card { 
            background: #111; border: 1px solid #333; padding: 20px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .h-info h4 { margin: 0 0 5px 0; color: #fff; font-family: 'Cinzel'; }
        .h-info p { margin: 0; color: #888; font-size: 0.9em; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
        .h-status { 
            padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
        }
        .status-pendente { background: rgba(255, 152, 0, 0.15); color: #ff9800; border: 1px solid #ff9800; }
        .status-enviado { background: rgba(46, 125, 50, 0.15); color: #81c784; border: 1px solid #81c784; }

        @media(max-width: 768px) { .oracles-section { grid-template-columns: 1fr; } .history-card { flex-direction: column; text-align: center; gap: 15px; } .h-info p { max-width: 100%; white-space: normal; } }
    </style>
</head>
<body>

<div id="loading-screen">
    <i class="fas fa-eye spinner"></i>
    <p style="color:#666; font-family:'Cinzel'; margin-top:15px; letter-spacing:2px;">Conectando aos Oráculos...</p>
</div>

<div class="container">
    <div class="nav-bar">
        <div onclick="window.location.href='dashboard-premium.html'" class="btn-back">← Voltar ao Hub</div>
    </div>

    <div class="page-header">
        <h1 class="page-title">CONSULTAS SAGRADAS</h1>
        <div class="page-sub">
            Acesse a sabedoria ancestral. Suas perguntas serão analisadas ritualisticamente e a resposta completa, densa e solucionadora será enviada ao seu e-mail dentro do tempo estipulado.
        </div>
    </div>

    <div class="oracles-section">
        <div class="oracle-card">
            <div class="oracle-header">
                <i class="fas fa-leaf oracle-icon"></i>
                <div>
                    <div class="oracle-name">Baralho Cigano</div>
                    <div class="oracle-time"><i class="fas fa-clock"></i> 30 Minutos</div>
                </div>
            </div>
            <div class="oracle-desc">
                Direto, assertivo e focado no cotidiano. O Baralho Cigano (Lenormand) é ideal para questões práticas sobre amor, trabalho, fofocas e acontecimentos imediatos. Ele não rodeia: mostra a realidade como ela é.
            </div>
        </div>

        <div class="oracle-card">
            <div class="oracle-header">
                <i class="fas fa-eye oracle-icon"></i>
                <div>
                    <div class="oracle-name">Tarot Egípcio</div>
                    <div class="oracle-time"><i class="fas fa-clock"></i> 40 Minutos</div>
                </div>
            </div>
            <div class="oracle-desc">
                O mais antigo e esotérico. Combina Astrologia, Numerologia e Simbologia Egípcia. Ideal para análises profundas de personalidade, conexões kármicas, missão de vida e entendimento das leis universais que regem seu momento.
            </div>
        </div>

        <div class="oracle-card">
            <div class="oracle-header">
                <i class="fas fa-shell oracle-icon"></i> <div>
                    <div class="oracle-name">Jogo de Búzios</div>
                    <div class="oracle-time"><i class="fas fa-clock"></i> 45 Minutos</div>
                </div>
            </div>
            <div class="oracle-desc">
                A voz dos Orixás. Este oráculo sagrado trata de destino (Odu), proteção espiritual e limpeza de caminhos. É a ferramenta certa para quando você sente sua vida travada por forças espirituais ou precisa de orientação divina sobre seu caminho (Ori).
            </div>
        </div>
    </div>

    <div class="ritual-form">
        <div class="counter-badge" id="limit-badge">...</div>

        <h2 style="color:var(--gold); font-family:'Cinzel'; text-align:center; margin-bottom:30px;">Inicie o Ritual de Consulta</h2>

        <div>
            <label class="form-label">1. Escolha o Oráculo:</label>
            <select id="oracle-selector" class="styled-select" onchange="atualizarTempo()">
                <option value="Baralho Cigano" data-time="30 minutos">Baralho Cigano (Prático - 30 min)</option>
                <option value="Tarot Egípcio" data-time="40 minutos">Tarot Egípcio (Profundo - 40 min)</option>
                <option value="Búzios" data-time="45 minutos">Jogo de Búzios (Espiritual - 45 min)</option>
            </select>
        </div>

        <div>
            <label class="form-label">2. Descreva sua Questão:</label>
            <textarea id="question-text" rows="6" class="styled-textarea" placeholder="Concentre-se. Digite sua pergunta com o máximo de detalhes possível para uma leitura precisa. Inclua nomes e datas se envolver terceiros."></textarea>
        </div>

        <div class="dynamic-time-info" id="time-display">
            <i class="fas fa-hourglass-half"></i> Previsão de entrega da resposta: <span class="highlight-time">30 Minutos</span>
        </div>

        <button id="btn-submit" class="btn-send" onclick="enviarConsulta()">Enviar ao Templo</button>
    </div>

    <div class="history-section">
        <h2 class="history-title">Meus Pedidos</h2>
        <div id="history-list" class="history-list">
            <p style="text-align:center; color:#666;">Carregando histórico...</p>
        </div>
    </div>

</div>

<script>
    // --- 1. FAILSAFE ---
    setTimeout(() => { document.getElementById('loading-screen').style.display = 'none'; }, 2000);

    // --- 2. CONFIGURAÇÕES ---
    const MAX_DAILY = 3;
    let usedCount = 0;
    let userUid = null;
    let userEmail = "";

    // --- 3. UI DINÂMICA ---
    function atualizarTempo() {
        const select = document.getElementById('oracle-selector');
        const selectedOption = select.options[select.selectedIndex];
        const time = selectedOption.getAttribute('data-time');
        document.getElementById('time-display').innerHTML = `<i class="fas fa-hourglass-half"></i> Previsão de entrega da resposta: <span class="highlight-time">${time}</span>`;
    }

    // --- 4. FUNÇÕES DO SISTEMA ---
    
    // Carregar Histórico do Firestore
    function carregarHistorico() {
        db.collection('perguntas')
          .where('uid', '==', userUid)
          .orderBy('data', 'desc')
          .limit(10)
          .onSnapshot(snapshot => {
              const lista = document.getElementById('history-list');
              lista.innerHTML = '';
              
              // Contagem do dia (reset diário simples via JS para UI)
              // Em produção ideal, o backend valida a data
              let countHoje = 0;
              const hojeStr = new Date().toDateString();

              if(snapshot.empty){
                  lista.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma consulta realizada ainda.</p>';
              }

              snapshot.forEach(doc => {
                  const d = doc.data();
                  const dataPed = d.data.toDate();
                  
                  // Verifica limite
                  if(dataPed.toDateString() === hojeStr) countHoje++;

                  // Renderiza Card
                  const card = document.createElement('div');
                  card.className = 'history-card';
                  
                  // Status simulado (Em produção viria do banco se foi respondido)
                  // Como não temos backend de resposta real aqui, deixamos como "Em Análise"
                  const statusClass = d.respondido ? 'status-enviado' : 'status-pendente';
                  const statusTexto = d.respondido ? 'RESPONDIDO' : 'EM ANÁLISE';

                  card.innerHTML = `
                      <div class="h-info">
                          <h4>${d.oraculo}</h4>
                          <p>"${d.pergunta}"</p>
                          <small style="color:#666">${dataPed.toLocaleString()}</small>
                      </div>
                      <div class="h-status ${statusClass}">
                          ${statusTexto}
                      </div>
                  `;
                  lista.appendChild(card);
              });

              // Atualiza contador UI
              usedCount = countHoje;
              atualizarLimiteUI();
          });
    }

    function atualizarLimiteUI() {
        const remaining = MAX_DAILY - usedCount;
        const badge = document.getElementById('limit-badge');
        const btn = document.getElementById('btn-submit');
        const txt = document.getElementById('question-text');

        badge.innerText = `Disponível Hoje: ${Math.max(0, remaining)} / ${MAX_DAILY}`;

        if (remaining <= 0) {
            btn.disabled = true;
            btn.innerText = "Limite Diário Atingido";
            btn.style.background = "#222";
            btn.style.border = "1px solid #333";
            txt.disabled = true;
            txt.placeholder = "Você atingiu o limite sagrado de 3 perguntas por dia. Volte amanhã.";
            txt.value = "";
        }
    }

    function enviarConsulta() {
        const question = document.getElementById('question-text').value.trim();
        const select = document.getElementById('oracle-selector');
        const type = select.value;
        const time = select.options[select.selectedIndex].getAttribute('data-time');
        const btn = document.getElementById('btn-submit');

        // Validação
        if (question.length < 15) {
            alert("Sua pergunta é muito breve. Por favor, forneça mais detalhes.");
            return;
        }

        if (usedCount >= MAX_DAILY) return;

        // Efeito de Envio
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando ao Templo...';

        // Salvar no Firestore
        db.collection('perguntas').add({
            uid: userUid,
            email: userEmail,
            oraculo: type,
            pergunta: question,
            tempoEstimado: time,
            data: firebase.firestore.FieldValue.serverTimestamp(),
            respondido: false // Backend mudaria isso depois
        }).then(() => {
            alert(`Sua pergunta ao ${type} foi recebida com sucesso! A resposta chegará no seu e-mail em até ${time}.`);
            document.getElementById('question-text').value = "";
            // O listener onSnapshot vai atualizar a lista e o contador automaticamente
            btn.disabled = false;
            btn.innerText = "Enviar ao Templo";
        }).catch((error) => {
            console.error("Erro:", error);
            alert("Erro ao enviar. Tente novamente.");
            btn.disabled = false;
            btn.innerText = "Enviar ao Templo";
        });
    }

    // --- 5. AUTH & INIT ---
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    auth.onAuthStateChanged(user => {
        if(user){
            userUid = user.uid;
            userEmail = user.email;
            document.getElementById('loading-screen').style.display = 'none';
            carregarHistorico();
            atualizarTempo();
        } else {
            window.location.href = 'index.html';
        }
    });
</script>
</body>
</html>