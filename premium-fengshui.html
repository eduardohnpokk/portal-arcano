<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Feng Shui Kua</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="auth-guard.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --card-bg: #0a0a0a; }
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; padding-bottom: 100px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header-title { font-family: 'Cinzel'; color: var(--gold); text-align: center; margin-top: 40px; font-size: 2.8em; }
        .intro-box { background: rgba(20, 20, 20, 0.9); border: 1px solid var(--gold); padding: 30px; margin-bottom: 40px; text-align: center; }
        
        .kua-header { display: flex; gap: 30px; margin-bottom: 40px; background: #0f0f0f; padding: 30px; border: 1px solid #333; }
        .kua-number { font-family: 'Cinzel'; font-size: 5em; color: var(--gold); }
        .directions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .direction-card { padding: 25px; border: 1px solid #333; background: #0a0a0a; border-radius: 8px; }
        .direction-card h4 { color: #fff; font-family: 'Cinzel'; margin: 0 0 10px 0; }
        .direction-card p { color: #aaa; margin: 0; font-size: 0.9em; }
        
        .success { border-left: 4px solid #4caf50; }
        .health { border-left: 4px solid #d4af37; }
        .love { border-left: 4px solid #ff69b4; }
        .stability { border-left: 4px solid #888; }
        .warning-box { margin-top: 30px; padding: 20px; border: 1px solid #ff4444; background: rgba(50,0,0,0.3); color: #ffcccc; text-align: center; }

        .btn-float { position: fixed; bottom: 30px; right: 30px; background: var(--gold); color: #000; padding: 15px 35px; border-radius: 50px; font-family: 'Cinzel'; font-weight: bold; cursor: pointer; border: none; }
        .btn-back { cursor: pointer; color: #888; text-transform: uppercase; font-size: 0.8em; margin-bottom: 20px; display: inline-block; }
        @media print { .btn-float, .btn-back { display: none; } body { background: #fff; color: #000; } .direction-card { border: 1px solid #000; background: #fff; color: #000; } }
    </style>
</head>
<body>

<div class="container">
    <div onclick="window.location.href='dashboard-premium.html'" class="btn-back">← VOLTAR AO HUB</div>
    <h1 class="header-title">FENG SHUI: KUA</h1>
    
    <div class="intro-box">
        <p>O <strong>Número Kua</strong> revela sua assinatura magnética. Ele indica quais direções cardeais fortalecem sua vitalidade e quais a drenam.</p>
    </div>

    <div id="result-area"></div>
</div>

<button class="btn-float" onclick="window.print()">SALVAR MAPA</button>

<script>
    // --- 1. BANCO DE DADOS EMBUTIDO ---
    const DIRECOES = {"N":"Norte","S":"Sul","L":"Leste","O":"Oeste","NE":"Nordeste","NO":"Noroeste","SE":"Sudeste","SO":"Sudoeste"};
    const MAPA_KUA = {
        "1":{elemento:"Água",sheng_qi:{dir:"SE",nome:"Sucesso"},tian_yi:{dir:"L",nome:"Saúde"},yan_nian:{dir:"S",nome:"Amor"},fu_wei:{dir:"N",nome:"Estabilidade"},azar:"SO"},
        "2":{elemento:"Terra",sheng_qi:{dir:"NE",nome:"Sucesso"},tian_yi:{dir:"O",nome:"Saúde"},yan_nian:{dir:"NO",nome:"Amor"},fu_wei:{dir:"SO",nome:"Estabilidade"},azar:"N"},
        "3":{elemento:"Madeira",sheng_qi:{dir:"S",nome:"Sucesso"},tian_yi:{dir:"N",nome:"Saúde"},yan_nian:{dir:"SE",nome:"Amor"},fu_wei:{dir:"L",nome:"Estabilidade"},azar:"O"},
        "4":{elemento:"Madeira",sheng_qi:{dir:"N",nome:"Sucesso"},tian_yi:{dir:"S",nome:"Saúde"},yan_nian:{dir:"L",nome:"Amor"},fu_wei:{dir:"SE",nome:"Estabilidade"},azar:"NE"},
        "6":{elemento:"Metal",sheng_qi:{dir:"O",nome:"Sucesso"},tian_yi:{dir:"NE",nome:"Saúde"},yan_nian:{dir:"SO",nome:"Amor"},fu_wei:{dir:"NO",nome:"Estabilidade"},azar:"S"},
        "7":{elemento:"Metal",sheng_qi:{dir:"NO",nome:"Sucesso"},tian_yi:{dir:"SO",nome:"Saúde"},yan_nian:{dir:"NE",nome:"Amor"},fu_wei:{dir:"O",nome:"Estabilidade"},azar:"L"},
        "8":{elemento:"Terra",sheng_qi:{dir:"SO",nome:"Sucesso"},tian_yi:{dir:"NO",nome:"Saúde"},yan_nian:{dir:"O",nome:"Amor"},fu_wei:{dir:"NE",nome:"Estabilidade"},azar:"SE"},
        "9":{elemento:"Fogo",sheng_qi:{dir:"L",nome:"Sucesso"},tian_yi:{dir:"SE",nome:"Saúde"},yan_nian:{dir:"N",nome:"Amor"},fu_wei:{dir:"S",nome:"Estabilidade"},azar:"NO"}
    };

    function calcularKua(ano, genero) {
        let total = 0; String(ano).split('').forEach(n => total += parseInt(n));
        while(total > 9) { let t=0; String(total).split('').forEach(n=>t+=parseInt(n)); total=t; }
        let kua = (genero === 'masculino') ? 11 - total : 4 + total;
        while(kua > 9) { let t=0; String(kua).split('').forEach(n=>t+=parseInt(n)); kua=t; }
        if (kua === 5) kua = (genero === 'masculino') ? 2 : 8;
        return String(kua);
    }

    function exibirKua(ano, genero) {
        const kua = calcularKua(ano, genero);
        const dados = MAPA_KUA[kua];
        
        document.getElementById('result-area').innerHTML = `
            <div class="kua-header">
                <div><span class="kua-number">${kua}</span></div>
                <div><h3>Elemento: ${dados.elemento}</h3><p>Este é seu código energético pessoal.</p></div>
            </div>
            <div class="directions-grid">
                <div class="direction-card success"><h4>${dados.sheng_qi.nome} (${DIRECOES[dados.sheng_qi.dir]})</h4><p>Vire sua mesa de trabalho para cá.</p></div>
                <div class="direction-card health"><h4>${dados.tian_yi.nome} (${DIRECOES[dados.tian_yi.dir]})</h4><p>Posicione a cabeceira da cama aqui.</p></div>
                <div class="direction-card love"><h4>${dados.yan_nian.nome} (${DIRECOES[dados.yan_nian.dir]})</h4><p>Harmonia familiar e romance.</p></div>
                <div class="direction-card stability"><h4>${dados.fu_wei.nome} (${DIRECOES[dados.fu_wei.dir]})</h4><p>Meditação e estudos.</p></div>
            </div>
            <div class="warning-box"><strong>EVITAR TOTALMENTE: ${DIRECOES[dados.azar]}</strong><p>Não durma com a cabeça apontada para esta direção.</p></div>
        `;
    }

    // --- 2. CONEXÃO SEGURA ---
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Inicia com padrão para não ficar vazio
    exibirKua(1985, 'masculino'); 

    auth.onAuthStateChanged(user => {
        if(user) {
            db.collection("usuarios").doc(user.uid).get().then(doc => {
                if(doc.exists && doc.data().dataNascimento) {
                    const ano = doc.data().dataNascimento.split('-')[0];
                    // Tenta adivinhar genero ou usa padrao (em app real, pediria genero no cadastro)
                    exibirKua(ano, 'masculino'); 
                }
            });
        }
    });
</script>
</body>
</html>