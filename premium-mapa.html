<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Mapa Astral Completo</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="astronomy.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js';"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- ESTILO VISUAL MANTIDO 100% --- */
        :root { --gold: #d4af37; --bg-dark: #050505; --card-bg: #0a0a0a; }
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; line-height: 1.6; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { font-size: 4em; color: var(--gold); animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px 20px; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-back { cursor: pointer; color: #666; text-transform: uppercase; font-size: 0.8em; letter-spacing: 2px; border-bottom: 1px solid transparent; transition:0.3s; }
        .btn-back:hover { color: var(--gold); border-color: var(--gold); }
        .btn-print { background: var(--gold); color: #000; border: none; padding: 8px 15px; border-radius: 4px; font-family: 'Cinzel'; cursor: pointer; font-weight: bold; }

        .page-header { text-align: center; margin-bottom: 40px; }
        .page-title { font-family: 'Cinzel'; color: var(--gold); font-size: 2.8em; margin: 0; text-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .user-details { color: #888; margin-top: 5px; font-size: 1.1em; letter-spacing: 1px; }

        .chart-container { display: flex; justify-content: center; margin: 40px 0; position: relative; }
        .mandala-svg { width: 100%; max-width: 500px; height: auto; filter: drop-shadow(0 0 20px rgba(212,175,55,0.1)); animation: rotateIn 2s ease-out; }
        @keyframes rotateIn { from { transform: rotate(-10deg); opacity: 0; } to { transform: rotate(0); opacity: 1; } }

        .data-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 60px; }
        .panel { background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .panel-header { background: #1a1a1a; padding: 15px; border-bottom: 1px solid var(--gold); font-family: 'Cinzel'; color: var(--gold); text-align: center; font-size: 1.2em; }
        .row { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid #222; font-size: 0.95em; }
        .row:last-child { border-bottom: none; }
        .lbl { color: #fff; display: flex; align-items: center; gap: 10px; }
        .val { color: #ccc; font-family: 'Cinzel'; }

        .deep-analysis { display: flex; flex-direction: column; gap: 40px; }
        .planet-block { background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-left: 4px solid var(--gold); padding: 30px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .planet-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .planet-icon { font-size: 2.5em; color: var(--gold); }
        .planet-title { font-family: 'Cinzel'; font-size: 1.8em; color: #fff; margin: 0; }
        .planet-sign-badge { background: #333; color: var(--gold); padding: 5px 15px; border-radius: 20px; font-family: 'Cinzel'; font-size: 0.9em; margin-left: auto; }
        .planet-text { color: #ccc; text-align: justify; margin-bottom: 0; font-size: 1.1em; line-height: 1.8; }
        .keyword { color: var(--gold); font-weight: bold; }

        .synthesis-box { margin-top: 60px; background: radial-gradient(circle at center, #222 0%, #000 100%); border: 2px solid var(--gold); padding: 50px; text-align: center; border-radius: 10px; }
        .synthesis-title { font-family: 'Cinzel'; font-size: 2.2em; color: var(--gold); margin-bottom: 30px; }
        .synthesis-text { font-size: 1.2em; color: #e0e0e0; text-align: justify; line-height: 2; }
        
        .house-desc { display: block; font-size: 0.85em; color: #888; margin-top: 5px; font-style: italic; }

        @media(max-width: 768px) { .data-section { grid-template-columns: 1fr; } .planet-header { flex-direction: column; text-align: center; } .planet-sign-badge { margin: 0; } }
        @media print { .btn-back, .btn-print { display: none; } body { background: #fff; color: #000; } .panel, .planet-block, .synthesis-box { background: #fff; color: #000; border: 1px solid #000; } .val, .planet-title, .synthesis-title, .keyword { color: #000 !important; } }
    </style>
</head>
<body>

<div id="loading-screen">
    <i class="fas fa-compass spinner"></i>
    <p id="loading-text" style="color:#666; font-family:'Cinzel'; margin-top:15px; letter-spacing:2px;">Iniciando Sistema...</p>
</div>

<div class="container">
    <div class="nav-bar">
        <div onclick="window.location.href='dashboard-premium.html'" class="btn-back">‚Üê Voltar ao Hub</div>
        <button onclick="window.print()" class="btn-print"><i class="fas fa-print"></i> Imprimir Mapa</button>
    </div>

    <div class="page-header">
        <h1 class="page-title">MAPA ASTRAL COMPLETO</h1>
        <div class="user-details" id="header-details">...</div>
    </div>

    <div class="chart-container" id="chart-area"></div>

    <div class="data-section">
        <div class="panel">
            <div class="panel-header">Posi√ß√µes Planet√°rias</div>
            <div id="planet-list"></div>
        </div>
        <div class="panel">
            <div class="panel-header">Casas Astrol√≥gicas</div>
            <div id="house-list"></div>
        </div>
    </div>

    <h2 style="text-align:center; color:var(--gold); font-family:'Cinzel'; margin-bottom:40px; font-size:2em;">AN√ÅLISE PROFUNDA DOS ASTROS</h2>
    <div class="deep-analysis" id="deep-content"></div>

    <div class="synthesis-box">
        <h2 class="synthesis-title">A TRADU√á√ÉO DA ALMA</h2>
        <div class="synthesis-text" id="synthesis-text"></div>
    </div>
</div>

<script>
    // ======================================================
    // 1. BANCO DE TEXTOS (INTEGRADO PARA EVITAR FALHAS)
    // ======================================================
    const ASTRO_DB = {
        planetas: {
            "Sol": { titulo: "Sua Ess√™ncia e Jornada do Her√≥i", essencia: "O Sol representa sua bateria vital, o centro da sua consci√™ncia e a figura do 'Rei' interno.", missao: "Sua miss√£o √© iluminar, liderar e expressar sua verdade individual." },
            "Lua": { titulo: "Nutri√ß√£o Emocional e Inconsciente", essencia: "A Lua rege suas rea√ß√µes instintivas, suas mem√≥rias e como voc√™ busca seguran√ßa.", missao: "Seu desafio √© processar emo√ß√µes e encontrar um lar dentro de si." },
            "Merc√∫rio": { titulo: "Processos Mentais e Comunica√ß√£o", essencia: "Merc√∫rio define como voc√™ processa informa√ß√µes e traduz a realidade para sua mente.", missao: "A meta √© conectar ideias e articular sua vis√£o com clareza." },
            "V√™nus": { titulo: "Linguagem do Amor e Valores", essencia: "V√™nus dita o que voc√™ valoriza, seu prazer e seu magnetismo pessoal.", missao: "Voc√™ busca criar harmonia e vivenciar o prazer sensorial da exist√™ncia." },
            "Marte": { titulo: "O Motor da A√ß√£o e Desejo", essencia: "Marte √© o princ√≠pio da afirma√ß√£o. √â onde voc√™ precisa ser assertivo para conquistar.", missao: "Sua jornada exige coragem para defender seu territ√≥rio e seus desejos." },
            "J√∫piter": { titulo: "A Busca por Sentido e Expans√£o", essencia: "J√∫piter √© o fil√≥sofo. Onde ele toca, ele expande. Representa f√© e otimismo.", missao: "O objetivo √© crescer al√©m dos limites, buscando sabedoria superior." },
            "Saturno": { titulo: "O Mestre da Realidade e Karma", essencia: "Saturno representa onde voc√™ sente medo, mas onde construir√° sua obra duradoura.", missao: "Sua tarefa √© desenvolver autodisciplina e responsabilidade total." },
            "Urano": { titulo: "O Despertador e o Rebelde", essencia: "Urano rege a intui√ß√£o rel√¢mpago, a quebra de padr√µes e a liberdade absoluta.", missao: "Voc√™ deve inovar e trazer o futuro para o presente." },
            "Netuno": { titulo: "O M√≠stico e a Dissolu√ß√£o", essencia: "Netuno dissolve o ego. Fala de onde voc√™ √© sens√≠vel, mas onde pode se iludir.", missao: "O chamado √© para transcender a realidade atrav√©s da espiritualidade ou arte." },
            "Plut√£o": { titulo: "O Agente de Transforma√ß√£o", essencia: "Plut√£o √© o poder nuclear da alma. Lida com morte, renascimento e o oculto.", missao: "Sua evolu√ß√£o depende de encarar sombras e renascer com poder." }
        },
        signos: {
            "√Åries": { adverbio: "de forma incisiva e corajosa", descricao: "veste uma armadura de fogo, priorizando a a√ß√£o direta e a iniciativa." },
            "Touro": { adverbio: "com const√¢ncia e pragmatismo", descricao: "ganha subst√¢ncia, valorizando a seguran√ßa material e o prazer sensorial." },
            "G√™meos": { adverbio: "atrav√©s da curiosidade e intelecto", descricao: "torna-se vers√°til e comunicativa, buscando sempre novas conex√µes mentais." },
            "C√¢ncer": { adverbio: "com prote√ß√£o e sensibilidade", descricao: "recua para a prote√ß√£o, guiada pela intui√ß√£o e pela necessidade de nutrir." },
            "Le√£o": { adverbio: "com nobreza e criatividade", descricao: "sobe ao palco, com uma necessidade vital de expressar seu brilho √∫nico." },
            "Virgem": { adverbio: "com crit√©rio e desejo de servir", descricao: "foca no detalhe, buscando a perfei√ß√£o, a ordem e a utilidade pr√°tica." },
            "Libra": { adverbio: "buscando harmonia e beleza", descricao: "pondera os lados, mediada pela diplomacia e pelo espelho dos relacionamentos." },
            "Escorpi√£o": { adverbio: "com intensidade e mist√©rio", descricao: "mergulha nas profundezas, investigando o oculto com poder regenerador." },
            "Sagit√°rio": { adverbio: "com otimismo e filosofia", descricao: "aponta para o distante, buscando a verdade maior e horizontes expandidos." },
            "Capric√≥rnio": { adverbio: "com ambi√ß√£o e estrutura", descricao: "escala a montanha, focada em metas de longo prazo e constru√ß√£o de legado." },
            "Aqu√°rio": { adverbio: "de maneira original e rebelde", descricao: "quebra padr√µes, focada no futuro, no coletivo e na liberdade intelectual." },
            "Peixes": { adverbio: "com empatia e fluidez", descricao: "dissolve fronteiras, movida por compaix√£o, sonhos e conex√£o espiritual." }
        },
        casas: {
            1: { nome: "Casa da Identidade", foco: "Isso afeta diretamente sua autoimagem e como voc√™ inicia projetos." },
            2: { nome: "Casa dos Valores", foco: "O cen√°rio √© a vida material, dinheiro e sua autoestima." },
            3: { nome: "Casa da Mente", foco: "A influ√™ncia ocorre na comunica√ß√£o, aprendizado e trocas di√°rias." },
            4: { nome: "Casa do Lar", foco: "Toca o fundo da alma: fam√≠lia, passado e sua vida privada." },
            5: { nome: "Casa da Criatividade", foco: "√â o palco da vida: romances, filhos e autoexpress√£o." },
            6: { nome: "Casa da Rotina", foco: "Manifesta-se no trabalho, na sa√∫de e na utilidade pr√°tica." },
            7: { nome: "Casa das Parcerias", foco: "O foco sai de voc√™ e vai para o casamento e sociedades." },
            8: { nome: "Casa da Transforma√ß√£o", foco: "Envolve crises, sexualidade profunda e o oculto." },
            9: { nome: "Casa da Expans√£o", foco: "Expande para viagens, filosofia e busca espiritual." },
            10: { nome: "Casa da Carreira", foco: "√â o ponto mais alto: reputa√ß√£o, voca√ß√£o e autoridade." },
            11: { nome: "Casa do Futuro", foco: "Atua nos grupos, amizades e projetos de longo prazo." },
            12: { nome: "Casa do Inconsciente", foco: "A √°rea do isolamento, espiritualidade e resgate c√°rmico." }
        }
    };

    function gerarInterpretacao(planeta, signo, casa) {
        const pInfo = ASTRO_DB.planetas[planeta] || ASTRO_DB.planetas["Sol"];
        const sInfo = ASTRO_DB.signos[signo] || ASTRO_DB.signos["√Åries"];
        const cInfo = ASTRO_DB.casas[casa] || ASTRO_DB.casas[1];

        return `
            <h4 style="color:#d4af37; font-family:'Cinzel'; font-size:1.4em; margin-bottom:5px; border-bottom:1px solid #333; padding-bottom:5px;">
                ${planeta} em ${signo} <span style="font-size:0.7em; color:#888;">(Casa ${casa})</span>
            </h4>
            <p style="color:#aaa; font-style:italic; font-size:0.9em; margin-bottom:15px;">
                "${pInfo.titulo}"
            </p>
            <p style="margin-bottom: 12px; text-align: justify;">
                <strong>A Din√¢mica:</strong> Nesta posi√ß√£o, ${pInfo.essencia.toLowerCase()} Aqui, essa for√ßa atua <strong>${sInfo.adverbio}</strong>. O arqu√©tipo de ${planeta} ${sInfo.descricao}
            </p>
            <p style="margin-bottom: 12px; text-align: justify;">
                <strong>O Cen√°rio (${cInfo.nome}):</strong> Essa combina√ß√£o √© canalizada para esta √°rea. ${cInfo.foco} √â aqui que voc√™ sentir√° a necessidade de expressar a energia de ${signo}.
            </p>
            <p style="background: rgba(212,175,55,0.1); padding: 10px; border-left: 3px solid #d4af37; font-size: 0.95em;">
                <strong>üí° Conselho:</strong> ${pInfo.missao}
            </p>
        `;
    }

    // ======================================================
    // 2. DADOS GEOGR√ÅFICOS
    // ======================================================
    const DB_CIDADES = {
        "sao paulo": { lat: -23.55, lon: -46.63 }, "sp": { lat: -23.55, lon: -46.63 },
        "rio de janeiro": { lat: -22.90, lon: -43.17 }, "rj": { lat: -22.90, lon: -43.17 },
        "brasilia": { lat: -15.79, lon: -47.89 }, "df": { lat: -15.79, lon: -47.89 },
        "salvador": { lat: -12.97, lon: -38.50 }, "ba": { lat: -12.97, lon: -38.50 },
        "fortaleza": { lat: -3.71, lon: -38.54 }, "ce": { lat: -3.71, lon: -38.54 },
        "belo horizonte": { lat: -19.91, lon: -43.93 }, "mg": { lat: -19.91, lon: -43.93 },
        "manaus": { lat: -3.11, lon: -60.02 }, "am": { lat: -3.11, lon: -60.02 },
        "curitiba": { lat: -25.42, lon: -49.27 }, "pr": { lat: -25.42, lon: -49.27 },
        "recife": { lat: -8.05, lon: -34.88 }, "pe": { lat: -8.05, lon: -34.88 },
        "goiania": { lat: -16.68, lon: -49.26 }, "go": { lat: -16.68, lon: -49.26 },
        "belem": { lat: -1.45, lon: -48.49 }, "pa": { lat: -1.45, lon: -48.49 },
        "porto alegre": { lat: -30.03, lon: -51.21 }, "rs": { lat: -30.03, lon: -51.21 },
        "campinas": { lat: -22.90, lon: -47.06 }, "guarulhos": { lat: -23.45, lon: -46.53 },
        "sao luis": { lat: -2.53, lon: -44.28 }, "ma": { lat: -2.53, lon: -44.28 },
        "maceio": { lat: -9.66, lon: -35.73 }, "al": { lat: -9.66, lon: -35.73 },
        "natal": { lat: -5.79, lon: -35.21 }, "rn": { lat: -5.79, lon: -35.21 },
        "teresina": { lat: -5.09, lon: -42.80 }, "pi": { lat: -5.09, lon: -42.80 },
        "campo grande": { lat: -20.46, lon: -54.62 }, "ms": { lat: -20.46, lon: -54.62 },
        "joao pessoa": { lat: -7.11, lon: -34.84 }, "pb": { lat: -7.11, lon: -34.84 },
        "aracaju": { lat: -10.94, lon: -37.07 }, "se": { lat: -10.94, lon: -37.07 },
        "cuiaba": { lat: -15.60, lon: -56.09 }, "mt": { lat: -15.60, lon: -56.09 },
        "porto velho": { lat: -8.76, lon: -63.90 }, "ro": { lat: -8.76, lon: -63.90 },
        "florianopolis": { lat: -27.59, lon: -48.54 }, "sc": { lat: -27.59, lon: -48.54 },
        "macapa": { lat: 0.03, lon: -51.07 }, "ap": { lat: 0.03, lon: -51.07 },
        "rio branco": { lat: -9.97, lon: -67.82 }, "ac": { lat: -9.97, lon: -67.82 },
        "vitoria": { lat: -20.31, lon: -40.31 }, "es": { lat: -20.31, lon: -40.31 },
        "boa vista": { lat: 2.82, lon: -60.67 }, "rr": { lat: 2.82, lon: -60.67 },
        "palmas": { lat: -10.24, lon: -48.32 }, "to": { lat: -10.24, lon: -48.32 },
        "surubim": { lat: -7.83, lon: -35.75 },
        "padrao": { lat: -15.79, lon: -47.88 }
    };

    const SIGNOS = ["√Åries", "Touro", "G√™meos", "C√¢ncer", "Le√£o", "Virgem", "Libra", "Escorpi√£o", "Sagit√°rio", "Capric√≥rnio", "Aqu√°rio", "Peixes"];
    const SIMBOLOS = ["‚ôà", "‚ôâ", "‚ôä", "‚ôã", "‚ôå", "‚ôç", "‚ôé", "‚ôè", "‚ôê", "‚ôë", "‚ôí", "‚ôì"];

    // --- 3. L√ìGICA PRINCIPAL ---
    
    function montarData(dStr, hStr) {
        let y = 2000, m = 1, d = 1;
        const cleanDate = String(dStr || "").trim();
        if(cleanDate.includes('-')) { const p = cleanDate.split('-'); y = parseInt(p[0]); m = parseInt(p[1]); d = parseInt(p[2]); }
        else if (cleanDate.includes('/')) { const p = cleanDate.split('/'); d = parseInt(p[0]); m = parseInt(p[1]); y = parseInt(p[2]); }
        const cleanTime = String(hStr || "12:00").trim();
        const tParts = cleanTime.split(':');
        const hr = parseInt(tParts[0] || 12);
        const min = parseInt(tParts[1] || 0);
        return new Date(y, m - 1, d, hr, min);
    }

    function pegarCoords(cidade, estado) {
        const c = (cidade || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        const e = (estado || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
        return DB_CIDADES[c] || DB_CIDADES[e] || DB_CIDADES["padrao"];
    }

    function executarSistema(nome, dataRaw, horaRaw, cidadeRaw, estadoRaw) {
        try {
            if (typeof Astronomy === 'undefined') throw new Error("Aguardando Astronomy...");

            document.getElementById('header-details').innerText = `${nome} ‚Ä¢ ${dataRaw} ‚Ä¢ ${horaRaw} ‚Ä¢ ${cidadeRaw}/${estadoRaw}`;
            const dateObj = montarData(dataRaw, horaRaw);
            const coords = pegarCoords(cidadeRaw, estadoRaw);

            // C√ÅLCULOS
            const dateAstronomy = Astronomy.MakeTime(dateObj);
            const observer = new Astronomy.Observer(coords.lat, coords.lon, 0);
            const planetas = [];
            const listaCorpos = ["Sun", "Moon", "Mercury", "Venus", "Mars", "Jupiter", "Saturn", "Uranus", "Neptune", "Pluto"];
            const nomesPT = {"Sun":"Sol", "Moon":"Lua", "Mercury":"Merc√∫rio", "Venus":"V√™nus", "Mars":"Marte", "Jupiter":"J√∫piter", "Saturn":"Saturno", "Uranus":"Urano", "Neptune":"Netuno", "Pluto":"Plut√£o"};

            listaCorpos.forEach(corpo => {
                const equ = Astronomy.Equator(corpo, dateAstronomy, observer, true, true);
                const long = Astronomy.Ecliptic(equ.vec).elon;
                planetas.push({ 
                    nome: nomesPT[corpo], 
                    grau: long,
                    signoIdx: Math.floor(long / 30),
                    grauNoSigno: Math.floor(long % 30)
                });
            });

            // Ascendente Simplificado
            let ascGrau = 0;
            try {
                const msd = Astronomy.SiderealTime(dateAstronomy);
                const lst = (msd + coords.lon / 15.0) * 15; 
                const ramc = lst * Math.PI/180;
                const eps = 23.439 * Math.PI/180;
                const lat = coords.lat * Math.PI/180;
                let ascRad = Math.atan2(Math.cos(ramc), -Math.sin(ramc)*Math.cos(eps) - Math.tan(lat)*Math.sin(eps));
                ascGrau = (ascRad * 180/Math.PI + 360) % 360;
            } catch(err) { ascGrau = 0; }
            const ascIdx = Math.floor(ascGrau / 30);

            const casas = [];
            for(let i=0; i<12; i++) {
                let g = (ascGrau + i*30) % 360;
                casas.push({ numero: i+1, grau: g, signoIdx: Math.floor(g/30) });
            }

            planetas.forEach(p => {
                let dist = (p.grau - ascGrau + 360) % 360;
                p.casa = Math.floor(dist/30) + 1;
            });

            // DESENHO
            const cx=200, cy=200, r=180;
            let svg = `<svg viewBox="0 0 400 400" class="mandala-svg"><circle cx="${cx}" cy="${cy}" r="${r}" stroke="#d4af37" stroke-width="2" fill="none"/><circle cx="${cx}" cy="${cy}" r="${r*0.7}" stroke="#333" stroke-width="1" fill="none"/>`;
            
            for(let i=0; i<12; i++) {
                const anguloDesenho = i * 30; 
                const rad = (anguloDesenho + 180) * Math.PI/180;
                const x2 = cx + r * Math.cos(rad);
                const y2 = cy + r * Math.sin(rad);
                svg += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#222" stroke-width="1"/>`;
                
                const sIdx = casas[i].signoIdx;
                const meioRad = (anguloDesenho + 15 + 180) * Math.PI/180;
                const tx = cx + r*0.88 * Math.cos(meioRad), ty = cy + r*0.88 * Math.sin(meioRad);
                svg += `<text x="${tx}" y="${ty}" text-anchor="middle" dominant-baseline="middle" fill="#d4af37" font-size="16" font-family="serif">${SIMBOLOS[sIdx]}</text>`;
                
                const nx = cx + r*0.2 * Math.cos(meioRad), ny = cy + r*0.2 * Math.sin(meioRad);
                svg += `<text x="${nx}" y="${ny}" text-anchor="middle" dominant-baseline="middle" fill="#555" font-size="9">${i+1}</text>`;
            }

            planetas.forEach((p, idx) => {
                let posRel = (p.grau - ascGrau + 360) % 360;
                let rad = (posRel + 180) * Math.PI/180;
                let varRaio = r*0.55 + (idx%3)*15;
                let px = cx + varRaio * Math.cos(rad), py = cy + varRaio * Math.sin(rad);
                const icons = {"Sol":"‚òâ","Lua":"‚òΩ","Merc√∫rio":"‚òø","V√™nus":"‚ôÄ","Marte":"‚ôÇ","J√∫piter":"‚ôÉ","Saturno":"‚ôÑ","Urano":"‚ôÖ","Netuno":"‚ôÜ","Plut√£o":"‚ôá"};
                svg += `<text x="${px}" y="${py}" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" style="filter:drop-shadow(0 0 2px #000)">${icons[p.nome]}</text>`;
            });
            svg += `</svg>`;
            document.getElementById('chart-area').innerHTML = svg;

            // PREENCHER DADOS
            const pList = document.getElementById('planet-list');
            const hList = document.getElementById('house-list');
            const dContent = document.getElementById('deep-content');
            pList.innerHTML = ''; hList.innerHTML = ''; dContent.innerHTML = '';

            planetas.forEach(p => {
                const sNome = SIGNOS[p.signoIdx];
                const icons = {"Sol":"‚òâ","Lua":"‚òΩ","Merc√∫rio":"‚òø","V√™nus":"‚ôÄ","Marte":"‚ôÇ","J√∫piter":"‚ôÉ","Saturno":"‚ôÑ","Urano":"‚ôÖ","Netuno":"‚ôÜ","Plut√£o":"‚ôá"};
                pList.innerHTML += `<div class="row"><div class="lbl"><span style="color:var(--gold); font-size:1.2em;">${icons[p.nome]}</span> ${p.nome}</div><div class="val">${sNome} <small>(${p.grauNoSigno}¬∞)</small></div></div>`;
                
                // GERA INTERPRETA√á√ÉO RICA
                dContent.innerHTML += `<div class="planet-block">${gerarInterpretacao(p.nome, sNome, p.casa)}</div>`;
            });

            casas.forEach(c => {
                hList.innerHTML += `<div class="row"><div class="lbl">Casa ${c.numero}</div><div class="val">${SIGNOS[c.signoIdx]}</div></div>`;
            });

            document.getElementById('synthesis-text').innerHTML = `Mapa de <strong>${nome}</strong> calculado para <strong>${cidadeRaw}</strong>.<br>Sol em <strong>${SIGNOS[planetas[0].signoIdx]}</strong>, Ascendente em <strong>${SIGNOS[ascIdx]}</strong>.`;
            document.getElementById('loading-screen').style.display = 'none';

        } catch (erro) {
            console.error(erro);
            // Retry se for erro de load, sen√£o mostra
            if(erro.message.includes("Astronomy")) {
                setTimeout(() => executarSistema(nome, dataRaw, horaRaw, cidadeRaw, estadoRaw), 500);
            } else {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('synthesis-text').innerHTML = `<span style="color:red">ERRO NO SISTEMA: ${erro.message}</span>`;
            }
        }
    }

    // --- 4. INICIALIZA√á√ÉO FIREBASE ---
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
        if(user){
            db.collection("usuarios").doc(user.uid).get().then(doc => {
                const d = doc.exists ? doc.data() : {};
                const status = (d.status || "").toLowerCase();
                const plano = (d.plano || "").toLowerCase();
                if(status !== "premium" && plano !== "premium") { window.location.href = 'dashboard.html'; return; }

                // Inicia com polling
                const loopCheck = setInterval(() => {
                    if(typeof Astronomy !== 'undefined') {
                        clearInterval(loopCheck);
                        executarSistema(d.nome || "Iniciado", d.dataNascimento, d.horaNascimento, d.cidade || "S√£o Paulo", d.estado || "SP");
                    }
                }, 200);

            }).catch(e => window.location.href = 'index.html');
        } else { window.location.href = 'index.html'; }
    });
</script>
</body>
</html>