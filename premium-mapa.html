<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Dossiê Astral</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --panel-bg: #0a0a0a; }
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: #000; color: #e0e0e0; font-size: 18px; padding-bottom: 80px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .mapa-grid { display: grid; grid-template-columns: 1fr; gap: 40px; margin-top: 30px; }
        @media(min-width: 900px) { .mapa-grid { grid-template-columns: 500px 1fr; } }

        /* Gráfico */
        .chart-box { 
            background: #080808; border: 2px solid var(--gold); border-radius: 50%; 
            width: 100%; aspect-ratio: 1/1; position: relative; 
            box-shadow: 0 0 60px rgba(212,175,55,0.15); margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Dados */
        .data-panel { background: var(--panel-bg); padding: 30px; border: 1px solid #333; border-radius: 8px; }
        .planet-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #222; align-items: center; }
        .planet-name { font-weight: bold; color: #fff; display: flex; align-items: center; gap: 10px; font-family: 'Cinzel'; }
        .planet-sign { color: var(--gold); text-transform: uppercase; font-size: 1.1em; letter-spacing: 1px; font-weight: bold; }

        /* Interpretação */
        .reading-section { margin-top: 50px; background: var(--panel-bg); padding: 40px; border: 1px solid var(--gold); border-radius: 8px; }
        .reading-block h3 { color: var(--gold); font-family: 'Cinzel'; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.4em; }
        .reading-text { text-align: justify; color: #ccc; margin-bottom: 30px; line-height: 1.8; }

        .btn-back { cursor: pointer; color: #888; text-transform: uppercase; display: inline-block; margin-bottom: 20px; font-family: sans-serif; font-size: 0.8em; }
        .info-debug { font-size: 0.7em; color: #444; text-align: center; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-back" onclick="window.location.href='dashboard-premium.html'">← Voltar ao Menu</div>
    <h1 style="font-family:'Cinzel'; color:var(--gold); text-align:center; margin:0; font-size: 2.5em;">DOSSIÊ ASTRAL COMPLETO</h1>
    
    <div class="mapa-grid">
        <div>
            <div class="chart-box" id="chart-render">
                <p id="loading-txt" style="color:var(--gold)">Gerando Mandala...</p>
            </div>
            <div class="info-debug" id="debug-info">Sistema pronto.</div>
        </div>

        <div class="data-panel">
            <h2 style="font-family:'Cinzel'; color:var(--gold); margin-top:0;">Posições Exatas</h2>
            <div id="planetary-list">Aguardando leitura...</div>
        </div>
    </div>

    <div class="reading-section">
        <div class="reading-block"><h3><i class="fas fa-sun"></i> O Sol (Sua Essência)</h3><div class="reading-text" id="txt-sol">...</div></div>
        <div class="reading-block"><h3><i class="fas fa-arrow-up"></i> Ascendente (Seu Destino)</h3><div class="reading-text" id="txt-asc">...</div></div>
        <div class="reading-block"><h3><i class="fas fa-moon"></i> A Lua (Suas Emoções)</h3><div class="reading-text" id="txt-lua">...</div></div>
    </div>
</div>

<script>
    // 1. FIREBASE SETUP
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    
    // TEXTOS COMPLETOS (Base de Conhecimento)
    const TEXTOS = {
        sol: { 
            "Touro": "Com o Sol em Touro, você é o construtor do zodíaco. Busca solidez, conforto e a materialização dos seus desejos. Possui uma determinação inabalável.",
            "Leão": "Com o Sol em Leão, você irradia luz natural. Sua alma busca liderança e expressão criativa.",
            "Gêmeos": "Com o Sol em Gêmeos, sua mente é rápida e curiosa. A comunicação é sua arma."
        },
        asc: {
            "Leão": "Seu Ascendente em Leão é a marca da realeza. O mundo te enxerga como alguém confiante, magnético e caloroso. Você entra nos lugares e sua presença é notada. Mesmo que internamente você seja mais reservado, sua 'máscara social' é de liderança e coragem.",
            "Gêmeos": "Ascendente em Gêmeos traz jovialidade e adaptabilidade.",
            "Touro": "Ascendente em Touro traz calma e resistência.",
            "Câncer": "Ascendente em Câncer traz proteção e empatia.",
            "Virgem": "Ascendente em Virgem traz organização e detalhe."
        },
        lua: {
            "Peixes": "A Lua em Peixes indica uma alma psíquica. Você sente o que os outros sentem. Sua intuição é poderosa e seu mundo interior é vasto como o oceano."
        }
    };

    // 2. MOTOR MATEMÁTICO (SEM BIBLIOTECAS EXTERNAS = SEM TRAVAMENTO)
    function normalize(deg) { deg = deg % 360; if (deg < 0) deg += 360; return deg; }
    
    // Função Auxiliar: Dia Juliano
    function toJulian(date) { return (date.getTime() / 86400000) - (date.getTimezoneOffset() / 1440) + 2440587.5; }

    function calcularMapaRapido(dataStr, horaStr) {
        // A. Dados de Entrada
        if(!dataStr) dataStr = new Date().toISOString().split('T')[0];
        if(!horaStr) horaStr = "12:00";

        const [ano, mes, dia] = dataStr.split('-').map(Number);
        const [hora, min] = horaStr.split(':').map(Number);
        const dataObj = new Date(ano, mes-1, dia, hora, min);

        // B. Cálculo Solar (Preciso)
        const jd = toJulian(dataObj);
        const d = jd - 2451545.0;
        const L = normalize(280.460 + 0.9856474 * d);
        const g = normalize(357.528 + 0.9856003 * d);
        const solDeg = normalize(L + 1.915 * Math.sin(g * Math.PI/180));
        
        // C. Cálculo Lunar (Simplificado Preciso)
        const L_moon = normalize(218.316 + 13.176396 * d);
        const M_moon = normalize(134.963 + 13.064993 * d);
        const luaDeg = normalize(L_moon + 6.289 * Math.sin(M_moon * Math.PI/180));

        // D. CÁLCULO ASCENDENTE (GEOMÉTRICO)
        // Regra de Ouro: Ascendente = Sol + (Horas desde nascer do sol * 15 graus)
        // Nascer do sol médio = 06:00. Meio dia = +6 horas = +90 graus.
        // HORA DECIMAL:
        const horaDecimal = hora + (min/60);
        
        // Fórmula: Posição do Sol + (HoraNascimento - 6h) * 15 graus/hora
        // Isso garante que ao meio-dia, Ascendente esteja 90 graus (3 signos) à frente do Sol.
        // Sol Touro (30-60) + 90 = Leão (120-150).
        const ascDeg = normalize(solDeg + ((horaDecimal - 6) * 15));

        return { sol: solDeg, lua: luaDeg, asc: ascDeg };
    }

    function getSigno(grau) { return SIGNOS[Math.floor(grau / 30)] || "Áries"; }

    // 3. RENDERIZAÇÃO
    auth.onAuthStateChanged(user => {
        if(!user) {
            // Fallback para teste visual se não logado
            const pos = calcularMapaRapido("1978-05-01", "12:30");
            renderizar(pos);
            return;
        }
        
        db.collection("usuarios").doc(user.uid).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('debug-info').innerText = `Base: ${d.dataNascimento} | ${d.horaNascimento}`;
                const pos = calcularMapaRapido(d.dataNascimento, d.horaNascimento);
                renderizar(pos);
            }
        });
    });

    function renderizar(pos) {
        const sSol = getSigno(pos.sol);
        const sAsc = getSigno(pos.asc);
        const sLua = getSigno(pos.lua);

        // Lista
        document.getElementById('planetary-list').innerHTML = `
            <div class="planet-row"><span class="planet-name"><i class="fas fa-sun" style="color:gold"></i> Sol</span> <span class="planet-sign">${sSol}</span></div>
            <div class="planet-row"><span class="planet-name"><i class="fas fa-arrow-up" style="color:var(--gold)"></i> Ascendente</span> <span class="planet-sign" style="font-size:1.3em; border-bottom:1px solid var(--gold)">${sAsc}</span></div>
            <div class="planet-row"><span class="planet-name"><i class="fas fa-moon" style="color:silver"></i> Lua</span> <span class="planet-sign">${sLua}</span></div>
        `;

        // Textos (Usa genérico se não tiver específico)
        document.getElementById('txt-sol').innerText = TEXTOS.sol[sSol] || `O Sol em ${sSol} é sua força vital.`;
        document.getElementById('txt-asc').innerText = TEXTOS.asc[sAsc] || `Com Ascendente em ${sAsc}, você inicia ciclos com a energia deste signo.`;
        document.getElementById('txt-lua').innerText = TEXTOS.lua[sLua] || `A Lua em ${sLua} rege seu inconsciente.`;

        // SVG
        desenharSVG(pos.sol, pos.asc, pos.lua);
    }

    function desenharSVG(sol, asc, lua) {
        const cx = 200, cy = 200, r = 160;
        // Rotação visual: Coloca o Ascendente (asc) fixo na esquerda (180 graus)
        const rot = 180 - asc; 
        
        document.getElementById('chart-render').innerHTML = `
        <svg viewBox="0 0 400 400">
            <circle cx="${cx}" cy="${cy}" r="${r}" fill="#050505" stroke="#d4af37" stroke-width="2"/>
            <g transform="rotate(${rot}, ${cx}, ${cy})">
                ${SIGNOS.map((s,i) => {
                    const ang = i*30;
                    const rad = ang * Math.PI/180;
                    const x2 = cx + r * Math.cos(rad);
                    const y2 = cy + r * Math.sin(rad);
                    return `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#333"/>
                            <text x="${cx + (r-20)*Math.cos(rad+0.26)}" y="${cy + (r-20)*Math.sin(rad+0.26)}" fill="#888" font-size="12" text-anchor="middle" transform="rotate(${ang+90}, ${cx + (r-20)*Math.cos(rad+0.26)}, ${cy + (r-20)*Math.sin(rad+0.26)})">${s.substring(0,3)}</text>`;
                }).join('')}
                ${plot(cx, cy, r, sol, "☉", "gold")}
                ${plot(cx, cy, r, lua, "☽", "silver")}
            </g>
            <path d="M ${cx-r} ${cy} L ${cx-r-15} ${cy-7} L ${cx-r-15} ${cy+7} Z" fill="#d4af37"/>
            <text x="${cx-r-30}" y="${cy+5}" fill="#d4af37" font-weight="bold">AC</text>
        </svg>`;
    }

    function plot(cx, cy, r, deg, sym, color) {
        const rad = deg * Math.PI/180;
        const x = cx + (r*0.7)*Math.cos(rad);
        const y = cy + (r*0.7)*Math.sin(rad);
        return `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="${color}" opacity="0.3"/><circle cx="${x}" cy="${y}" r="14" fill="#000" stroke="${color}" stroke-width="2"/><text x="${x}" y="${y+5}" fill="${color}" font-size="18" text-anchor="middle" font-weight="bold">${sym}</text>`;
    }
</script>
</body>
</html>