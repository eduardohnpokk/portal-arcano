<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Dossiê Astral</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --panel-bg: #0a0a0a; }
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: #000; color: #e0e0e0; font-size: 18px; padding-bottom: 80px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .mapa-grid { display: grid; grid-template-columns: 1fr; gap: 40px; margin-top: 30px; }
        @media(min-width: 900px) { .mapa-grid { grid-template-columns: 500px 1fr; } }

        /* Gráfico */
        .chart-box { 
            background: #080808; border: 2px solid var(--gold); border-radius: 50%; 
            width: 100%; aspect-ratio: 1/1; position: relative; 
            box-shadow: 0 0 60px rgba(212,175,55,0.15); margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Dados */
        .data-panel { background: var(--panel-bg); padding: 30px; border: 1px solid #333; border-radius: 8px; }
        .planet-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #222; align-items: center; }
        .planet-name { font-weight: bold; color: #fff; display: flex; align-items: center; gap: 10px; font-family: 'Cinzel'; }
        .planet-sign { color: var(--gold); text-transform: uppercase; font-size: 1em; letter-spacing: 1px; font-weight: bold; }

        /* Texto */
        .reading-section { margin-top: 50px; background: var(--panel-bg); padding: 40px; border: 1px solid var(--gold); border-radius: 8px; }
        .reading-block h3 { color: var(--gold); font-family: 'Cinzel'; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; font-size: 1.4em; }
        .reading-text { text-align: justify; color: #ccc; margin-bottom: 30px; line-height: 1.8; }

        .btn-back { cursor: pointer; color: #888; text-transform: uppercase; display: inline-block; margin-bottom: 20px; font-family: sans-serif; font-size: 0.8em; }
        .info-debug { font-size: 0.7em; color: #444; text-align: center; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-back" onclick="window.location.href='dashboard-premium.html'">← Voltar ao Menu</div>
    <h1 style="font-family:'Cinzel'; color:var(--gold); text-align:center; margin:0; font-size: 2.5em;">DOSSIÊ ASTRAL COMPLETO</h1>
    
    <div class="mapa-grid">
        <div>
            <div class="chart-box" id="chart-render"></div>
            <div class="info-debug" id="debug-info">Aguardando dados...</div>
        </div>

        <div class="data-panel">
            <h2 style="font-family:'Cinzel'; color:var(--gold); margin-top:0;">Posições Exatas</h2>
            <div id="planetary-list">Carregando efemérides...</div>
        </div>
    </div>

    <div class="reading-section">
        <div class="reading-block"><h3><i class="fas fa-sun"></i> O Sol (Sua Essência)</h3><div class="reading-text" id="txt-sol">...</div></div>
        <div class="reading-block"><h3><i class="fas fa-arrow-up"></i> Ascendente (Seu Destino)</h3><div class="reading-text" id="txt-asc">...</div></div>
        <div class="reading-block"><h3><i class="fas fa-moon"></i> A Lua (Suas Emoções)</h3><div class="reading-text" id="txt-lua">...</div></div>
    </div>
</div>

<script>
    // 1. FIREBASE
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    const GEO_DB = {
        "SP": {lat:-23.55, lon:-46.63}, "SAO PAULO": {lat:-23.55, lon:-46.63},
        "RJ": {lat:-22.90, lon:-43.17}, "RIO": {lat:-22.90, lon:-43.17},
        "MG": {lat:-19.91, lon:-43.93}, "BH": {lat:-19.91, lon:-43.93},
        "DF": {lat:-15.79, lon:-47.88}, "BRASILIA": {lat:-15.79, lon:-47.88},
        "DEFAULT": {lat:-23.55, lon:-46.63}
    };

    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    
    // TEXTOS COMPLETOS E REAIS
    const TEXTOS = {
        sol: { 
            "Touro": "Com o Sol em Touro, você é o construtor do zodíaco. Sua essência busca estabilidade, prazer sensorial e segurança material. Você possui uma paciência inabalável e uma determinação de ferro. Seu desafio é vencer a inércia e a teimosia.",
            "Leão": "Com o Sol em Leão, você nasceu para brilhar. Generosidade, criatividade e liderança são seus dons naturais.",
            "Gêmeos": "Com o Sol em Gêmeos, sua mente é rápida e curiosa. Você veio para comunicar e conectar pessoas."
        },
        asc: {
            "Leão": "Seu Ascendente em Leão indica que você se apresenta ao mundo com realeza e magnetismo. Mesmo sendo Touro (reservado), sua primeira impressão é de alguém confiante, caloroso e com autoridade natural. Você veio para liderar e ser notado.",
            "Gêmeos": "Ascendente em Gêmeos confere jovialidade e curiosidade.",
            "Touro": "Ascendente em Touro confere calma e solidez."
        },
        lua: {
            "Peixes": "A Lua em Peixes confere uma sensibilidade mediúnica. Você sente as emoções do ambiente. É empático, sonhador e precisa de momentos de isolamento para recarregar."
        }
    };

    // 2. CÁLCULO UTC CORRIGIDO
    function calcularMapaUTC(dataStr, horaStr, localStr) {
        // A. Coordenadas
        let lat = -23.55, lon = -46.63;
        if(localStr) {
            const busca = localStr.toUpperCase();
            for(let k in GEO_DB) if(busca.includes(k)) { lat = GEO_DB[k].lat; lon = GEO_DB[k].lon; break; }
        }

        // B. DATA UTC FORÇADA (Aqui estava o erro: antes usava hora local do browser)
        const [ano, mes, dia] = dataStr.split('-').map(Number);
        const [hora, min] = horaStr.split(':').map(Number);
        
        // Criamos a data tratando a hora digitada como UTC-3 (Brasil)
        // Então somamos 3 horas para obter o UTC real para o Astronomy Engine
        const dateUTC = new Date(Date.UTC(ano, mes - 1, dia, hora + 3, min));

        // C. Astronomy Engine
        const observer = new Astronomy.Observer(lat, lon, 0);
        const sunPos = Astronomy.Ecliptic('Sun', dateUTC, observer, false, true);
        const moonPos = Astronomy.Ecliptic('Moon', dateUTC, observer, false, true);

        // D. Ascendente (Fórmula Rigorosa com GMST Correto)
        const gmst = Astronomy.SiderealTime(dateUTC); 
        let lstDeg = (gmst * 15) + lon; 
        if (lstDeg < 0) lstDeg += 360;
        if (lstDeg > 360) lstDeg -= 360;

        const eps = 23.439 * (Math.PI/180);
        const latRad = lat * (Math.PI/180);
        const lstRad = lstDeg * (Math.PI/180);

        const y = Math.cos(lstRad);
        const x = -(Math.sin(lstRad) * Math.cos(eps)) - (Math.tan(latRad) * Math.sin(eps));
        let ascDeg = Math.atan2(y, x) * (180/Math.PI);
        if (ascDeg < 0) ascDeg += 360;

        return { 
            sol: sunPos.elon, 
            lua: moonPos.elon, 
            asc: ascDeg,
            debugTime: dateUTC.toISOString()
        };
    }

    function getSigno(grau) { return SIGNOS[Math.floor(grau / 30)] || "Áries"; }

    // 3. RENDER
    auth.onAuthStateChanged(user => {
        if(!user) return window.location.href = 'index.html';
        
        db.collection("usuarios").doc(user.uid).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                const hora = d.horaNascimento || "12:00";
                
                const pos = calcularMapaUTC(d.dataNascimento, hora, d.localNascimento);
                
                // Debug Visual para confirmação
                document.getElementById('debug-info').innerText = `Base: ${d.dataNascimento} ${hora} (SP) -> Cálculo UTC: ${pos.debugTime.split('T')[1].slice(0,5)}`;

                const sSol = getSigno(pos.sol);
                const sAsc = getSigno(pos.asc);
                const sLua = getSigno(pos.lua);

                document.getElementById('planetary-list').innerHTML = `
                    <div class="planet-row"><span class="planet-name"><i class="fas fa-sun" style="color:gold"></i> Sol</span> <span class="planet-sign">${sSol} ${(pos.sol%30).toFixed(2)}°</span></div>
                    <div class="planet-row"><span class="planet-name"><i class="fas fa-arrow-up" style="color:var(--gold)"></i> Ascendente</span> <span class="planet-sign" style="font-size:1.2em; border-bottom:1px solid var(--gold)">${sAsc} ${(pos.asc%30).toFixed(2)}°</span></div>
                    <div class="planet-row"><span class="planet-name"><i class="fas fa-moon" style="color:silver"></i> Lua</span> <span class="planet-sign">${sLua} ${(pos.lua%30).toFixed(2)}°</span></div>
                `;

                // Busca texto específico ou usa genérico
                document.getElementById('txt-sol').innerText = TEXTOS.sol[sSol] || `O Sol em ${sSol} ilumina sua vida.`;
                document.getElementById('txt-asc').innerText = TEXTOS.asc[sAsc] || `O Ascendente em ${sAsc} define sua abordagem ao mundo.`;
                document.getElementById('txt-lua').innerText = TEXTOS.lua[sLua] || `A Lua em ${sLua} rege suas emoções.`;

                desenharSVG(pos.sol, pos.asc, pos.lua);
            }
        });
    });

    function desenharSVG(sol, asc, lua) {
        const cx = 200, cy = 200, r = 160;
        const rot = 180 - asc; 
        
        document.getElementById('chart-render').innerHTML = `
        <svg viewBox="0 0 400 400">
            <circle cx="${cx}" cy="${cy}" r="${r}" fill="#050505" stroke="#d4af37" stroke-width="2"/>
            <g transform="rotate(${rot}, ${cx}, ${cy})">
                ${SIGNOS.map((s,i) => {
                    const ang = i*30;
                    const rad = ang * Math.PI/180;
                    const x2 = cx + r * Math.cos(rad);
                    const y2 = cy + r * Math.sin(rad);
                    return `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#333"/>
                            <text x="${cx + (r-20)*Math.cos(rad+0.26)}" y="${cy + (r-20)*Math.sin(rad+0.26)}" fill="#aaa" font-size="12" text-anchor="middle" transform="rotate(${ang+90}, ${cx + (r-20)*Math.cos(rad+0.26)}, ${cy + (r-20)*Math.sin(rad+0.26)})">${s.substring(0,3)}</text>`;
                }).join('')}
                ${plot(cx, cy, r, sol, "☉", "gold")}
                ${plot(cx, cy, r, lua, "☽", "silver")}
            </g>
            <path d="M ${cx-r} ${cy} L ${cx-r-15} ${cy-7} L ${cx-r-15} ${cy+7} Z" fill="#d4af37"/>
            <text x="${cx-r-30}" y="${cy+5}" fill="#d4af37" font-weight="bold">AC</text>
        </svg>`;
    }

    function plot(cx, cy, r, deg, sym, color) {
        const rad = deg * Math.PI/180;
        const x = cx + (r*0.7)*Math.cos(rad);
        const y = cy + (r*0.7)*Math.sin(rad);
        return `<line x1="${cx}" y1="${cy}" x2="${x}" y2="${y}" stroke="${color}" opacity="0.3"/><circle cx="${x}" cy="${y}" r="13" fill="#000" stroke="${color}" stroke-width="2"/><text x="${x}" y="${y+5}" fill="${color}" font-size="16" text-anchor="middle" font-weight="bold">${sym}</text>`;
    }
</script>
</body>
</html>