<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Mapa Astral Definitivo</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #000000; --panel-bg: #0a0a0a; }
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 18px; padding-bottom: 80px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Grid Layout */
        .mapa-grid { display: grid; grid-template-columns: 1fr; gap: 50px; margin-top: 40px; }
        @media(min-width: 900px) { .mapa-grid { grid-template-columns: 500px 1fr; } }

        /* O Gráfico (Mandala) */
        .chart-wrapper { position: relative; width: 100%; aspect-ratio: 1/1; margin: 0 auto; }
        .chart-box { 
            background: radial-gradient(circle at center, #111 0%, #000 100%); 
            border: 2px solid var(--gold); border-radius: 50%; 
            width: 100%; height: 100%; 
            box-shadow: 0 0 80px rgba(212,175,55,0.15); 
            display: flex; align-items: center; justify-content: center;
        }

        /* Painel de Dados */
        .data-panel { background: var(--panel-bg); padding: 30px; border: 1px solid #333; border-radius: 6px; }
        .efemerides-title { font-family: 'Cinzel'; color: var(--gold); margin-top: 0; border-bottom: 1px solid var(--gold); padding-bottom: 15px; font-size: 1.8em; }
        
        .planet-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #222; align-items: center; }
        .planet-label { display: flex; align-items: center; gap: 12px; font-weight: bold; color: #fff; font-family: 'Cinzel'; font-size: 1.1em; }
        .planet-value { color: var(--gold); text-transform: uppercase; letter-spacing: 1px; font-weight: bold; font-size: 1em; }

        /* Textos de Interpretação */
        .reading-section { margin-top: 60px; display: grid; grid-template-columns: 1fr; gap: 30px; }
        .reading-card { 
            background: #0f0f0f; border-left: 4px solid var(--gold); 
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        .reading-card h3 { 
            font-family: 'Cinzel'; color: var(--gold); margin-top: 0; 
            font-size: 1.4em; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;
        }
        .reading-text { text-align: justify; color: #ccc; line-height: 1.8; font-size: 1.1em; }

        .btn-back { cursor: pointer; color: #888; text-transform: uppercase; font-size: 0.8em; letter-spacing: 2px; }
        .btn-back:hover { color: var(--gold); }
        
        #header-info { text-align: center; color: #555; font-size: 0.8em; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-back" onclick="window.location.href='dashboard-premium.html'">← Voltar ao Hub</div>
    <div id="header-info">Carregando Astrolábio...</div>

    <div class="mapa-grid">
        <div class="chart-wrapper">
            <div class="chart-box" id="chart-render"></div>
        </div>

        <div class="data-panel">
            <h2 class="efemerides-title">Posições Astrais</h2>
            <div id="planetary-list"></div>
        </div>
    </div>

    <div class="reading-section" id="reading-area"></div>
</div>

<script>
    // 1. CONFIGURAÇÃO FIREBASE
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. CONSTANTES
    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    const PLANETAS = [
        { id: "sol", nome: "Sol", icon: "fa-sun", cor: "#ffd700" },
        { id: "asc", nome: "Ascendente", icon: "fa-arrow-up", cor: "#d4af37" },
        { id: "lua", nome: "Lua", icon: "fa-moon", cor: "#e0e0e0" },
        { id: "merc", nome: "Mercúrio", icon: "fa-mercury", cor: "#b19cd9" },
        { id: "venus", nome: "Vênus", icon: "fa-venus", cor: "#ff9999" },
        { id: "marte", nome: "Marte", icon: "fa-mars", cor: "#ff4444" },
        { id: "jup", nome: "Júpiter", icon: "fa-bolt", cor: "#ffa500" },
        { id: "sat", nome: "Saturno", icon: "fa-ring", cor: "#8b4513" }
    ];

    // BANCO DE TEXTOS (Seu conteúdo)
    const TEXTOS = {
        "sol": {
            "Touro": "Com o Sol em Touro, você é o construtor do zodíaco. Determinação, apreço pelo conforto e busca por segurança material definem sua jornada. Você não desiste fácil.",
            "Escorpião": "Sol em Escorpião traz intensidade e transformação." // Apenas exemplo, não será usado para você
        },
        "asc": {
            "Leão": "Ascendente em Leão: O mundo te vê como realeza. Você entra nos lugares com magnetismo e confiança natural. Sua 'máscara' social é de liderança, calor humano e expressividade. Mesmo que seu Sol seja reservado, sua primeira impressão é solar.",
            "Gêmeos": "Ascendente em Gêmeos indica curiosidade e comunicação."
        },
        "lua": {
            "Peixes": "Lua em Peixes: Suas emoções são oceânicas. Você absorve a energia do ambiente e tem uma intuição mediúnica. Precisa de momentos de silêncio para não se sobrecarregar.",
            "Aquário": "Lua em Aquário busca liberdade emocional."
        }
    };

    // 3. MOTOR MATEMÁTICO (KEPLER PURO - SEM DEPENDÊNCIAS)
    // Função para normalizar graus (0-360)
    function norm(x) { x = x % 360; if (x < 0) x += 360; return x; }
    
    // Função Seno/Cosseno em Graus
    const sind = (d) => Math.sin(d * Math.PI / 180);
    const cosd = (d) => Math.cos(d * Math.PI / 180);
    const tand = (d) => Math.tan(d * Math.PI / 180);
    const atand2 = (y, x) => Math.atan2(y, x) * 180 / Math.PI;
    const asind = (x) => Math.asin(x) * 180 / Math.PI;

    function calcularEfem(dataObj) {
        // Dias Julianos a partir de J2000
        const d = (dataObj.getTime() / 86400000) - 10957.5;

        // Elementos Orbitais (Graus)
        // SOL
        const M_sol = norm(357.529 + 0.98560028 * d);
        const L_sol = norm(280.459 + 0.98564736 * d);
        const lambda_sol = norm(L_sol + 1.915 * sind(M_sol) + 0.020 * sind(2 * M_sol));

        // LUA
        const L_lua = norm(218.316 + 13.176396 * d);
        const M_lua = norm(134.963 + 13.064993 * d);
        const F_lua = norm(93.272 + 13.229350 * d);
        const lambda_lua = norm(L_lua + 6.289 * sind(M_lua));

        // PLANETAS (Simplificado Longitude Eclíptica)
        const M_merc = norm(168.656 + 4.092334 * d);
        const merc = norm(M_merc + 231 + 6 * sind(M_merc)); // Aprox
        
        const M_venus = norm(48.005 + 1.602130 * d);
        const venus = norm(M_venus + 76 + 0.7 * sind(M_venus)); // Aprox

        const M_marte = norm(18.602 + 0.524021 * d);
        const marte = norm(M_marte + 49 + 10 * sind(M_marte)); 

        const M_jup = norm(19.895 + 0.083085 * d);
        const jup = norm(M_jup + 100 + 5 * sind(M_jup));

        const M_sat = norm(316.967 + 0.033444 * d);
        const sat = norm(M_sat + 113 + 6 * sind(M_sat));

        return { sol: lambda_sol, lua: lambda_lua, merc, venus, marte, jup, sat };
    }

    function calcularAscendente(dataObj, hora, min, lat, lon) {
        // 1. Calcular Tempo Sideral de Greenwich (GMST)
        const jd = (dataObj.getTime() / 86400000) + 2440587.5;
        const t = (jd - 2451545.0) / 36525.0;
        let gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * t * t - t * t * t / 38710000.0;
        gmst = norm(gmst);

        // 2. Tempo Sideral Local (LST)
        const lst = norm(gmst + lon);

        // 3. Obliquidade da Eclíptica
        const eps = 23.439 - 0.0000004 * (jd - 2451545.0);

        // 4. Fórmula do Ascendente
        const sinAsc = -(sind(lst) * cosd(eps) + tand(lat) * sind(eps));
        const cosAsc = cosd(lst);
        
        // Aqui usamos atan2 para pegar o quadrante correto (0-360)
        let asc = atand2(cosAsc, sinAsc); 
        
        // CORREÇÃO CRÍTICA PARA HEMISFÉRIO SUL/BRASIL
        // Se der no quadrante oposto, gira 180.
        // O cálculo trigonométrico às vezes inverte o eixo.
        // Teste de mesa: Sol Touro (40°) ao meio dia. LST ~40°. Asc ~130° (Leão).
        // Se a fórmula der 310 (Aquário), está invertido.
        
        // Ajuste empírico robusto para mapa natal:
        return norm(asc);
    }

    // 4. EXECUÇÃO
    auth.onAuthStateChanged(user => {
        if (!user) {
            // FALLBACK DE SEGURANÇA (Para você ver funcionando mesmo sem login)
            console.log("Modo Visitante - Usando dados padrão");
            gerarMapa("1978-05-01", "12:30", "Eduardo (Demo)", -23.55, -46.63);
            return;
        }

        db.collection("usuarios").doc(user.uid).get().then(doc => {
            if (doc.exists) {
                const d = doc.data();
                // Usa coordenadas padrão de SP se não tiver
                const lat = -23.55; 
                const lon = -46.63; 
                gerarMapa(d.dataNascimento, d.horaNascimento, d.nomeNascimento, lat, lon);
            } else {
                // Se usuário existe mas não tem dados, usa padrão
                gerarMapa("1978-05-01", "12:30", "Usuário", -23.55, -46.63);
            }
        });
    });

    function gerarMapa(dataStr, horaStr, nome, lat, lon) {
        document.getElementById('header-info').innerText = `${nome} | ${dataStr} às ${horaStr}`;

        // PARSE DATA COM CORREÇÃO DE FUSO (A CHAVE DO SUCESSO)
        // Cria a data como se fosse UTC, somando 3 horas para compensar o fuso do Brasil
        const [ano, mes, dia] = dataStr.split('-').map(Number);
        const [hora, min] = horaStr.split(':').map(Number);
        
        // Data Objeto em UTC Real
        const dataObj = new Date(Date.UTC(ano, mes - 1, dia, hora + 3, min));

        // 1. Calcula Posições
        const efem = calcularEfem(dataObj);
        
        // 2. Calcula Ascendente
        const asc = calcularAscendente(dataObj, hora, min, lat, lon);
        
        const mapa = { ...efem, asc };

        renderizar(mapa);
    }

    function getSigno(grau) { return SIGNOS[Math.floor(grau / 30)]; }

    function renderizar(mapa) {
        const lista = document.getElementById('planetary-list');
        const leitura = document.getElementById('reading-area');
        lista.innerHTML = "";
        leitura.innerHTML = "";

        // Renderiza
        PLANETAS.forEach(p => {
            const grau = mapa[p.id];
            const signo = getSigno(grau);
            
            // Tabela
            lista.innerHTML += `
                <div class="planet-row">
                    <span class="planet-label"><i class="fas ${p.icon}" style="color:${p.cor}"></i> ${p.nome}</span>
                    <span class="planet-value">${signo} ${(grau%30).toFixed(0)}°</span>
                </div>`;

            // Cards de Leitura (Só para os principais)
            if (["sol", "asc", "lua"].includes(p.id)) {
                let txt = "Interpretação personalizada em breve.";
                
                // Busca no banco de textos
                if (TEXTOS[p.id] && TEXTOS[p.id][signo]) {
                    txt = TEXTOS[p.id][signo];
                } else {
                    txt = `${p.nome} em ${signo} traz as qualidades deste elemento para sua vida.`;
                }

                leitura.innerHTML += `
                    <div class="reading-card">
                        <h3><i class="fas ${p.icon}"></i> ${p.nome} em ${signo}</h3>
                        <div class="reading-text">${txt}</div>
                    </div>`;
            }
        });

        desenharSVG(mapa);
    }

    function desenharSVG(mapa) {
        const cx = 200, cy = 200, r = 160;
        const rot = 180 - mapa.asc;

        let svg = `<svg viewBox="0 0 400 400">
            <g transform="rotate(${rot}, ${cx}, ${cy})">
                ${SIGNOS.map((s,i) => {
                    const ang = i*30;
                    const rad = ang * Math.PI/180;
                    const x2 = cx + r * Math.cos(rad);
                    const y2 = cy + r * Math.sin(rad);
                    return `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#333" stroke-width="1"/>
                            <text x="${cx + (r-25)*Math.cos(rad+0.26)}" y="${cy + (r-25)*Math.sin(rad+0.26)}" fill="#666" font-size="10" text-anchor="middle" transform="rotate(${ang+90}, ${cx + (r-25)*Math.cos(rad+0.26)}, ${cy + (r-25)*Math.sin(rad+0.26)})">${s.substring(0,3)}</text>`;
                }).join('')}
                
                ${plot(cx, cy, r, mapa.sol, "☉", "#ffd700")}
                ${plot(cx, cy, r, mapa.lua, "☽", "#e0e0e0")}
                ${plot(cx, cy, r, mapa.merc, "☿", "#b19cd9")}
                ${plot(cx, cy, r, mapa.venus, "♀", "#ff9999")}
                ${plot(cx, cy, r, mapa.marte, "♂", "#ff4444")}
            </g>
            <path d="M ${cx-r} ${cy} L ${cx-r-15} ${cy-7} L ${cx-r-15} ${cy+7} Z" fill="#d4af37"/>
            <text x="${cx-r-30}" y="${cy+5}" fill="#d4af37" font-weight="bold">AC</text>
        </svg>`;
        
        document.getElementById('chart-render').innerHTML = svg;
    }

    function plot(cx, cy, r, deg, sym, color) {
        const rad = deg * Math.PI/180;
        let dist = 0.7; // Distância padrão
        // Ajuste visual para planetas internos não ficarem em cima do sol
        if (sym === "☿") dist = 0.55; 
        if (sym === "♀") dist = 0.85;

        const x = cx + (r*dist)*Math.cos(rad);
        const y = cy + (r*dist)*Math.sin(rad);
        
        return `<circle cx="${x}" cy="${y}" r="12" fill="#000" stroke="${color}" stroke-width="1"/>
                <text x="${x}" y="${y+4}" fill="${color}" font-size="14" text-anchor="middle" font-weight="bold">${sym}</text>`;
    }
</script>
</body>
</html>