<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossiê Astral Completo</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="astro-database.js"></script> 

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; }
        
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; padding-bottom: 100px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        .header-title { font-family: 'Cinzel'; color: var(--gold); text-align: center; margin-top: 30px; font-size: 3em; letter-spacing: 3px; }
        .header-sub { text-align: center; color: #888; margin-bottom: 50px; font-family: sans-serif; text-transform: uppercase; letter-spacing: 1px; }

        /* GRID */
        .mapa-grid { display: grid; grid-template-columns: 1fr; gap: 50px; margin-bottom: 80px; align-items: start; }
        @media(min-width: 900px) { .mapa-grid { grid-template-columns: 1fr 400px; } }

        .chart-box { 
            background: radial-gradient(circle at center, #111 0%, #000 100%); 
            border: 2px solid var(--gold); border-radius: 50%; 
            width: 100%; aspect-ratio: 1/1; position: relative; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 60px rgba(212,175,55,0.15);
        }

        .data-panel { border: 1px solid #333; padding: 30px; border-radius: 8px; background: #0a0a0a; }
        .planet-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #222; }
        .planet-label { color: #fff; font-family: 'Cinzel'; font-weight: bold; display: flex; gap: 10px; align-items: center; }
        .planet-sign { color: var(--gold); font-weight: bold; text-transform: uppercase; }

        /* LEITURA */
        .reading-section { display: flex; flex-direction: column; gap: 60px; }
        .chapter { 
            background: #0f0f0f; padding: 50px; border-radius: 4px;
            position: relative; overflow: hidden; border-left: 5px solid var(--gold);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .chapter h3 { 
            font-family: 'Cinzel'; color: var(--gold); margin: 0 0 30px 0; font-size: 2em; 
            border-bottom: 1px solid #333; padding-bottom: 15px; 
        }
        
        .chapter-content { text-align: justify; line-height: 2; color: #ccc; font-size: 1.15em; }
        .chapter-content strong { color: #fff; }

        /* IMPRESSÃO */
        .btn-float {
            position: fixed; bottom: 30px; right: 30px; 
            background: var(--gold); color: #000; 
            padding: 20px 40px; border-radius: 50px; 
            font-family: 'Cinzel'; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 100; border: none; font-size: 1.2em;
        }

        @media print {
            body { background: #fff; color: #000; }
            .btn-float, .btn-back { display: none !important; }
            .chart-box { border: 2px solid #000; background: #fff !important; filter: invert(1); width: 350px; height: 350px; margin: 0 auto; }
            .chapter { background: #fff; border: none; padding: 0; box-shadow: none; page-break-inside: avoid; margin-bottom: 50px; }
            .chapter h3 { color: #000; border-bottom: 2px solid #000; }
            .chapter-content { color: #000; }
            .data-panel { border: 1px solid #000; background: #fff; }
            .planet-row { border-bottom: 1px solid #ccc; }
            .planet-label, .planet-sign { color: #000; }
            .header-title { color: #000; text-shadow: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-back" onclick="window.location.href='dashboard-premium.html'" style="cursor:pointer; color:#888; margin-bottom:20px;">← VOLTAR</div>
    
    <h1 class="header-title">DOSSIÊ ASTRAL</h1>
    <div class="header-sub" id="header-info">Carregando seus dados...</div>

    <div class="mapa-grid">
        <div class="chart-box" id="chart-render"></div>
        <div class="data-panel">
            <h3 style="color:var(--gold); font-family:'Cinzel'; margin-top:0; border-bottom:1px solid var(--gold); padding-bottom:10px;">Mapa Natal</h3>
            <div id="planetary-list">Calculando...</div>
        </div>
    </div>

    <div class="reading-section" id="reading-area"></div>
</div>

<button class="btn-float" onclick="window.print()"><i class="fas fa-print"></i> IMPRIMIR PDF</button>

<script>
    // 1. CONFIGURAÇÃO
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    const PLANETAS = [
        { id: "sol", nome: "Sol", icon: "fa-sun" },
        { id: "asc", nome: "Ascendente", icon: "fa-arrow-up" },
        { id: "lua", nome: "Lua", icon: "fa-moon" },
        { id: "merc", nome: "Mercúrio", icon: "fa-mercury" },
        { id: "venus", nome: "Vênus", icon: "fa-venus" },
        { id: "marte", nome: "Marte", icon: "fa-mars" },
        { id: "jup", nome: "Júpiter", icon: "fa-bolt" },
        { id: "sat", nome: "Saturno", icon: "fa-ring" }
    ];

    // 2. MOTOR MATEMÁTICO (KEPLER SEM DEPENDÊNCIAS)
    function norm(x) { x = x % 360; if (x < 0) x += 360; return x; }
    const sind = (d) => Math.sin(d * Math.PI / 180);
    const cosd = (d) => Math.cos(d * Math.PI / 180);
    const tand = (d) => Math.tan(d * Math.PI / 180);
    const atand2 = (y, x) => Math.atan2(y, x) * 180 / Math.PI;

    function calcularPosicoes(dataObj, lat, lon) {
        const d = (dataObj.getTime() / 86400000) - 10957.5;
        const L_sol = norm(280.466 + 0.985647 * d);
        const M_sol = norm(357.529 + 0.985600 * d);
        const sol = norm(L_sol + 1.915 * sind(M_sol));
        const L_lua = norm(218.316 + 13.176396 * d);
        const M_lua = norm(134.963 + 13.064993 * d);
        const lua = norm(L_lua + 6.289 * sind(M_lua));
        const merc = norm(sol + 22 * sind(d * 4.09)); 
        const venus = norm(sol + 44 * sind(d * 1.6)); 
        const marte = norm(18.6 + 0.524 * d); 
        const jup = norm(19.9 + 0.083 * d);
        const sat = norm(316.9 + 0.033 * d);

        // Ascendente
        const jd = (dataObj.getTime() / 86400000) + 2440587.5;
        const t = (jd - 2451545.0) / 36525.0;
        let gmst = norm(280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * t * t);
        const lst = norm(gmst + lon);
        const eps = 23.439;
        const sinAsc = -(sind(lst) * cosd(eps) + tand(lat) * sind(eps));
        const cosAsc = cosd(lst);
        const asc = norm(atand2(cosAsc, sinAsc));

        return { sol, lua, merc, venus, marte, jup, sat, asc };
    }

    // 3. EXECUÇÃO
    auth.onAuthStateChanged(user => {
        if(!user) return window.location.href = 'index.html';
        
        db.collection("usuarios").doc(user.uid).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                processar(d.nomeNascimento, d.dataNascimento, d.horaNascimento);
            }
        });
    });

    function processar(nome, dataStr, horaStr) {
        document.getElementById('header-info').innerText = `${nome} | ${dataStr} às ${horaStr}`;
        
        // DATA UTC-3 FIXO
        const [ano, mes, dia] = dataStr.split('-').map(Number);
        const [hora, min] = horaStr.split(':').map(Number);
        const dataObj = new Date(Date.UTC(ano, mes-1, dia, hora+3, min));
        
        const pos = calcularPosicoes(dataObj, -23.55, -46.63);
        renderizar(pos);
    }

    function getSigno(grau) { return SIGNOS[Math.floor(grau / 30)]; }

    function renderizar(pos) {
        const lista = document.getElementById('planetary-list');
        const area = document.getElementById('reading-area');
        lista.innerHTML = "";
        area.innerHTML = "";

        PLANETAS.forEach(p => {
            const val = pos[p.id];
            const signo = getSigno(val);
            
            // Tabela
            lista.innerHTML += `
                <div class="planet-row">
                    <span class="planet-label"><i class="fas ${p.icon}"></i> ${p.nome}</span>
                    <span class="planet-sign">${signo}</span>
                </div>`;

            // Texto (Lê do GRIMORIO_ESTELAR importado)
            let txt = "";
            
            // Verifica se o GRIMORIO foi carregado corretamente
            if (typeof GRIMORIO_ESTELAR !== 'undefined' && GRIMORIO_ESTELAR[p.id] && GRIMORIO_ESTELAR[p.id][signo]) {
                txt = GRIMORIO_ESTELAR[p.id][signo];
            } else {
                txt = `<p><strong>${p.nome} em ${signo}:</strong> Esta posição revela uma faceta importante da sua personalidade. A energia de ${signo} modula a expressão de ${p.nome} em sua vida. (Texto detalhado em expansão).</p>`;
            }

            area.innerHTML += `<div class="chapter">${txt}</div>`;
        });

        desenharSVG(pos);
    }

    function desenharSVG(pos) {
        const cx = 175, cy = 175, r = 140;
        const rot = 180 - pos.asc;
        let svg = `<svg viewBox="0 0 350 350"><g transform="rotate(${rot}, ${cx}, ${cy})">`;
        
        // Casas
        SIGNOS.forEach((s, i) => {
            const ang = i*30; const rad = ang*Math.PI/180;
            const x2 = cx + r*Math.cos(rad); const y2 = cy + r*Math.sin(rad);
            svg += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#333" />`;
            // Texto signo
            const tx = cx + (r-20)*Math.cos(rad+0.26);
            const ty = cy + (r-20)*Math.sin(rad+0.26);
            svg += `<text x="${tx}" y="${ty}" fill="#666" font-size="10" transform="rotate(${ang+90}, ${tx}, ${ty})" text-anchor="middle">${s.substring(0,3)}</text>`;
        });

        // Planetas
        PLANETAS.forEach(p => {
            const rad = pos[p.id] * Math.PI/180;
            // Distancia variada para não encavalar
            let dist = 0.7;
            if(p.id === 'merc' || p.id === 'venus') dist = 0.55;
            if(p.id === 'marte' || p.id === 'jup') dist = 0.85;
            
            const px = cx + (r*dist)*Math.cos(rad);
            const py = cy + (r*dist)*Math.sin(rad);
            
            let color = "#fff";
            if(p.id === 'sol') color = "#ffd700";
            if(p.id === 'asc') color = "#d4af37";

            svg += `<circle cx="${px}" cy="${py}" r="8" fill="#000" stroke="${color}" />`;
            // Icone simples (letra)
            const symbol = p.nome.substring(0,1);
            svg += `<text x="${px}" y="${py+3}" fill="${color}" font-size="10" text-anchor="middle" font-weight="bold">${symbol}</text>`;
        });

        svg += `</g><path d="M ${cx-r} ${cy} L ${cx-r-15} ${cy-5} L ${cx-r-15} ${cy+5} Z" fill="#d4af37"/></svg>`;
        document.getElementById('chart-render').innerHTML = svg;
    }
</script>
</body>
</html>