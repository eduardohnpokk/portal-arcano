<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Mapa Astral Completo</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --card-bg: #0a0a0a; }
        
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; line-height: 1.6; }
        
        /* LOADING */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { font-size: 4em; color: var(--gold); animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* LAYOUT */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px 20px 100px 20px; }
        
        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-back { cursor: pointer; color: #666; text-transform: uppercase; font-size: 0.8em; letter-spacing: 2px; border-bottom: 1px solid transparent; transition:0.3s; }
        .btn-back:hover { color: var(--gold); border-color: var(--gold); }
        .btn-print { background: var(--gold); color: #000; border: none; padding: 8px 15px; border-radius: 4px; font-family: 'Cinzel'; cursor: pointer; font-weight: bold; }

        .page-header { text-align: center; margin-bottom: 40px; }
        .page-title { font-family: 'Cinzel'; color: var(--gold); font-size: 2.8em; margin: 0; text-shadow: 0 0 20px rgba(212,175,55,0.3); }
        .user-details { color: #888; margin-top: 5px; font-size: 1.1em; letter-spacing: 1px; }

        /* MANDALA */
        .chart-container { display: flex; justify-content: center; margin: 40px 0; position: relative; }
        .mandala-svg { width: 100%; max-width: 500px; height: auto; filter: drop-shadow(0 0 20px rgba(212,175,55,0.1)); animation: rotateIn 2s ease-out; }
        @keyframes rotateIn { from { transform: rotate(-10deg); opacity: 0; } to { transform: rotate(0); opacity: 1; } }

        /* TABELAS */
        .data-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 60px; }
        .panel { background: #111; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .panel-header { background: #1a1a1a; padding: 15px; border-bottom: 1px solid var(--gold); font-family: 'Cinzel'; color: var(--gold); text-align: center; font-size: 1.2em; }
        
        .row { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid #222; font-size: 0.95em; }
        .row:last-child { border-bottom: none; }
        .lbl { color: #fff; display: flex; align-items: center; gap: 10px; }
        .val { color: #ccc; font-family: 'Cinzel'; }

        /* INTERPRETAÇÃO */
        .deep-analysis { display: flex; flex-direction: column; gap: 40px; }
        
        .planet-block { 
            background: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-left: 4px solid var(--gold); 
            padding: 30px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .planet-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .planet-icon { font-size: 2.5em; color: var(--gold); }
        .planet-title { font-family: 'Cinzel'; font-size: 1.8em; color: #fff; margin: 0; }
        .planet-sign-badge { background: #333; color: var(--gold); padding: 5px 15px; border-radius: 20px; font-family: 'Cinzel'; font-size: 0.9em; margin-left: auto; }
        
        .planet-text { color: #ccc; text-align: justify; margin-bottom: 0; font-size: 1.1em; line-height: 1.8; }
        .keyword { color: var(--gold); font-weight: bold; }

        .synthesis-box { 
            margin-top: 60px; background: radial-gradient(circle at center, #222 0%, #000 100%); 
            border: 2px solid var(--gold); padding: 50px; text-align: center; border-radius: 10px;
        }
        .synthesis-title { font-family: 'Cinzel'; font-size: 2.2em; color: var(--gold); margin-bottom: 30px; }
        .synthesis-text { font-size: 1.2em; color: #e0e0e0; text-align: justify; line-height: 2; }

        .house-desc { display: block; font-size: 0.85em; color: #888; margin-top: 5px; font-style: italic; }

        @media(max-width: 768px) { .data-section { grid-template-columns: 1fr; } .planet-header { flex-direction: column; text-align: center; } .planet-sign-badge { margin: 0; } }
        @media print { .btn-back, .btn-print { display: none; } body { background: #fff; color: #000; } .panel, .planet-block, .synthesis-box { background: #fff; color: #000; border: 1px solid #000; } .val, .planet-title, .synthesis-title, .keyword { color: #000 !important; } }
    </style>
</head>
<body>

<div id="loading-screen">
    <i class="fas fa-compass spinner"></i>
    <p id="loading-text" style="color:#666; font-family:'Cinzel'; margin-top:15px; letter-spacing:2px;">Iniciando Sistema...</p>
</div>

<div class="container">
    <div class="nav-bar">
        <div onclick="window.location.href='dashboard-premium.html'" class="btn-back">← Voltar ao Hub</div>
        <button onclick="window.print()" class="btn-print"><i class="fas fa-print"></i> Imprimir Mapa</button>
    </div>

    <div class="page-header">
        <h1 class="page-title">MAPA ASTRAL COMPLETO</h1>
        <div class="user-details" id="header-details">...</div>
    </div>

    <div class="chart-container" id="chart-area"></div>

    <div class="data-section">
        <div class="panel">
            <div class="panel-header">Posições Planetárias</div>
            <div id="planet-list"></div>
        </div>
        <div class="panel">
            <div class="panel-header">Casas Astrológicas</div>
            <div id="house-list"></div>
        </div>
    </div>

    <h2 style="text-align:center; color:var(--gold); font-family:'Cinzel'; margin-bottom:40px; font-size:2em;">ANÁLISE PROFUNDA DOS ASTROS</h2>
    <div class="deep-analysis" id="deep-content"></div>

    <div class="synthesis-box">
        <h2 class="synthesis-title">A TRADUÇÃO DA ALMA</h2>
        <div class="synthesis-text" id="synthesis-text"></div>
    </div>

</div>

<script>
    // --- DADOS E ARQUÉTIPOS ---
    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    const SIMBOLOS = ["♈", "♉", "♊", "♋", "♌", "♍", "♎", "♏", "♐", "♑", "♒", "♓"];
    
    const ARQUETIPOS = {
        "Sol": "Sua Essência e Propósito", "Lua": "Seu Mundo Emocional", "Mercúrio": "Sua Comunicação",
        "Vênus": "Seus Valores e Amor", "Marte": "Sua Ação e Conquista", "Júpiter": "Sua Expansão e Fé",
        "Saturno": "Seus Limites e Estrutura", "Urano": "Sua Originalidade", "Netuno": "Sua Espiritualidade",
        "Plutão": "Seu Poder de Transformação"
    };

    // --- 1. GEOCODIFICAÇÃO DINÂMICA (ROBUSTA) ---
    async function buscarCoordenadas(cidade, estado) {
        document.getElementById('loading-text').innerText = `Localizando ${cidade}...`;
        let coords = { lat: -15.79, lon: -47.88, nome: "Padrão (Brasília)" }; // Fallback
        
        try {
            // Tenta busca precisa: Cidade, Estado, Brazil
            let query = `${cidade}, ${estado}, Brazil`;
            let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
            let response = await fetch(url);
            let data = await response.json();

            // Se falhar, tenta busca ampla: Cidade, Brazil
            if (!data || data.length === 0) {
                query = `${cidade}, Brazil`;
                url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                response = await fetch(url);
                data = await response.json();
            }

            if (data && data.length > 0) {
                coords = {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    nome: data[0].display_name.split(',')[0]
                };
            }
        } catch (e) {
            console.error("Erro GPS:", e);
        }
        return coords;
    }

    // --- 2. CÁLCULOS ASTRONÔMICOS (ZODÍACO TROPICAL) ---
    function normalizarGraus(g) {
        let res = g % 360;
        if (res < 0) res += 360;
        return res;
    }

    function getSignoDeGraus(graus) {
        const index = Math.floor(graus / 30);
        return {
            nome: SIGNOS[index],
            simbolo: SIMBOLOS[index],
            grauNoSigno: Math.floor(graus % 30),
            index: index
        };
    }

    function calcularMapaPreciso(dataStr, horaStr, lat, lon) {
        // DATA: Força Fuso Horário -03:00 (Brasília) para garantir consistência
        const dataISO = `${dataStr}T${horaStr}:00-03:00`;
        const dataLocal = new Date(dataISO);
        
        const observer = new Astronomy.Observer(lat, lon, 0);
        const corpos = ["Sun", "Moon", "Mercury", "Venus", "Mars", "Jupiter", "Saturn", "Uranus", "Neptune", "Pluto"];
        const resultadosPlanetas = [];

        // Para cada planeta, calculamos Longitude Eclíptica TROPICAL
        corpos.forEach(corpo => {
            // Equator 'of date' já inclui precessão (Tropical)
            const equator = Astronomy.Equator(corpo, dataLocal, observer, true, true);
            
            // Conversão Manual RA/Dec -> Longitude Eclíptica (Tropical)
            // Fórmula padrão de transformação de coordenadas
            const dateValues = Astronomy.MakeTime(dataLocal);
            const eps = Astronomy.Obliquity(dateValues) * (Math.PI / 180); // Obliquidade da Eclíptica
            const ra = equator.ra * 15 * (Math.PI / 180); // Converter horas para radianos
            const dec = equator.dec * (Math.PI / 180);

            // Fórmula: tan(lon) = (sin(ra) * cos(eps) + tan(dec) * sin(eps)) / cos(ra)
            const y = Math.sin(ra) * Math.cos(eps) + Math.tan(dec) * Math.sin(eps);
            const x = Math.cos(ra);
            let lonRad = Math.atan2(y, x);
            let lonGraus = normalizarGraus(lonRad * (180 / Math.PI));

            resultadosPlanetas.push({
                nome: traduzirPlaneta(corpo),
                graus: lonGraus,
                signoInfo: getSignoDeGraus(lonGraus),
                casa: 0
            });
        });

        // CÁLCULO DO ASCENDENTE (Fórmula Geométrica Rigorosa)
        const dateValues = Astronomy.MakeTime(dataLocal);
        const gmst = Astronomy.SiderealTime(dateValues);
        const lmst = gmst + (lon / 15.0); // Hora Sideral Local
        const ramc = normalizarGraus(lmst * 15);
        const eps = Astronomy.Obliquity(dateValues) * (Math.PI / 180);
        const latRad = lat * (Math.PI / 180);
        const ramcRad = ramc * (Math.PI / 180);

        // Fórmula Ascendente: atan2(cos(RAMC), -sin(RAMC)*cos(eps) - tan(lat)*sin(eps))
        let ascRad = Math.atan2(
            Math.cos(ramcRad),
            -Math.sin(ramcRad) * Math.cos(eps) - Math.tan(latRad) * Math.sin(eps)
        );
        let ascGraus = normalizarGraus(ascRad * (180 / Math.PI));
        const ascendenteInfo = getSignoDeGraus(ascGraus);

        // CASAS (Sistema Casas Iguais a partir do Ascendente - Mais estável)
        const casas = [];
        for(let i=0; i<12; i++) {
            let cuspide = normalizarGraus(ascGraus + (i * 30));
            casas.push({ numero: i+1, grau: cuspide, signoInfo: getSignoDeGraus(cuspide) });
        }

        // Distribui planetas nas casas
        resultadosPlanetas.forEach(p => {
            let diff = normalizarGraus(p.graus - ascGraus);
            p.casa = Math.floor(diff / 30) + 1;
        });

        return { planetas: resultadosPlanetas, ascendente: ascendenteInfo, casas: casas };
    }

    function traduzirPlaneta(nome) {
        const mapa = {"Sun":"Sol", "Moon":"Lua", "Mercury":"Mercúrio", "Venus":"Vênus", "Mars":"Marte", "Jupiter":"Júpiter", "Saturn":"Saturno", "Uranus":"Urano", "Neptune":"Netuno", "Pluto":"Plutão"};
        return mapa[nome];
    }

    // --- 3. TEXTOS E RENDERIZAÇÃO ---
    function gerarTextoProfundo(planeta, signo, casa) {
        return `<strong>${planeta} em ${signo} (Casa ${casa}):</strong><br>A energia de ${planeta} (${ARQUETIPOS[planeta]}) manifesta-se através do filtro de ${signo}. Isso significa que você expressa essa faceta da sua vida de forma ${getAdjetivoSigno(signo)}. Como este posicionamento ocorre na <strong>Casa ${casa}</strong>, essa dinâmica impacta diretamente ${getSignificadoCasa(casa)}.`;
    }

    function getAdjetivoSigno(nome) {
        const adjs = {
            "Áries": "impulsiva e pioneira", "Touro": "estável e sensorial", "Gêmeos": "curiosa e versátil", "Câncer": "emocional e protetora",
            "Leão": "expressiva e nobre", "Virgem": "analítica e detalhista", "Libra": "diplomática e sociável", "Escorpião": "intensa e profunda",
            "Sagitário": "otimista e filosófica", "Capricórnio": "ambiciosa e estruturada", "Aquário": "original e livre", "Peixes": "intuitiva e empática"
        };
        return adjs[nome] || "única";
    }

    function getSignificadoCasa(num) {
        const significados = [
            "sua identidade e autoimagem", "suas finanças e valores", "sua comunicação e estudos", "seu lar e família",
            "sua criatividade e romances", "seu trabalho e saúde", "seus relacionamentos sérios", "suas transformações e crises",
            "seus ideais e viagens", "sua carreira e propósito", "seus grupos e amizades", "sua espiritualidade e medos"
        ];
        return significados[num-1];
    }

    async function renderizar(nome, dataStr, horaStr, cidade, estado) {
        // Try/Catch para evitar TELA PRETA se der erro no GPS
        try {
            document.getElementById('header-details').innerText = `${nome} • ${dataStr} • ${horaStr} • ${cidade}/${estado}`;
            
            // 1. Obter Lat/Long
            const coords = await buscarCoordenadas(cidade, estado);
            
            document.getElementById('loading-text').innerText = "Calculando Mapa...";
            
            // 2. Calcular Mapa
            const dados = calcularMapaPreciso(dataStr, horaStr, coords.lat, coords.lon);
            
            // 3. Desenhar
            desenharSVG(dados);

            // 4. Preencher Tabelas
            const pList = document.getElementById('planet-list');
            const hList = document.getElementById('house-list');
            const dContent = document.getElementById('deep-content');
            
            pList.innerHTML = ''; hList.innerHTML = ''; dContent.innerHTML = '';

            dados.planetas.forEach(p => {
                const icons = {"Sol":"☉","Lua":"☽","Mercúrio":"☿","Vênus":"♀","Marte":"♂","Júpiter":"♃","Saturno":"♄","Urano":"♅","Netuno":"♆","Plutão":"♇"};
                pList.innerHTML += `<div class="row"><div class="lbl"><span style="color:var(--gold); font-size:1.2em;">${icons[p.nome]}</span> ${p.nome}</div><div class="val">${p.signoInfo.nome} <small>(${p.signoInfo.grauNoSigno}°)</small></div></div>`;
                
                dContent.innerHTML += `
                    <div class="planet-block">
                        <div class="planet-header">
                            <div class="planet-icon">${icons[p.nome]}</div>
                            <h3 class="planet-title">${p.nome}</h3>
                            <div class="planet-sign-badge">${p.signoInfo.nome} • Casa ${p.casa}</div>
                        </div>
                        <p class="planet-text">${gerarTextoProfundo(p.nome, p.signoInfo.nome, p.casa)}</p>
                    </div>
                `;
            });

            dados.casas.forEach(c => {
                hList.innerHTML += `
                    <div class="row" style="flex-direction:column; align-items:flex-start;">
                        <div style="display:flex; justify-content:space-between; width:100%;">
                            <div class="lbl house-num">Casa ${c.numero}</div>
                            <div class="val">${c.signoInfo.nome}</div>
                        </div>
                        <span class="house-desc">Área de ${getSignificadoCasa(c.numero)}</span>
                    </div>
                `;
            });

            document.getElementById('synthesis-text').innerHTML = `
                Seu Mapa Astral foi calculado com precisão astronômica para <strong>${coords.nome || cidade}</strong> (Lat: ${coords.lat.toFixed(2)}, Lon: ${coords.lon.toFixed(2)}).<br><br>
                Você é um ser solar em <strong>${dados.planetas[0].signoInfo.nome}</strong> com Ascendente em <strong>${dados.ascendente.nome}</strong>. 
                Isso indica que sua jornada de vida é iluminada pela energia de ${getAdjetivoSigno(dados.planetas[0].signoInfo.nome)}, mas você inicia seus caminhos com a postura ${getAdjetivoSigno(dados.ascendente.nome)}.
            `;

        } catch (erroCritico) {
            console.error(erroCritico);
            alert("Erro ao calcular mapa. Verifique sua conexão ou dados.");
        } finally {
            document.getElementById('loading-screen').style.display = 'none';
        }
    }

    function desenharSVG(dados) {
        const cx = 200, cy = 200, r = 180;
        let svg = `<svg viewBox="0 0 400 400" class="mandala-svg">`;
        svg += `<circle cx="${cx}" cy="${cy}" r="${r}" stroke="#d4af37" stroke-width="2" fill="none" />`;
        svg += `<circle cx="${cx}" cy="${cy}" r="${r*0.7}" stroke="#333" stroke-width="1" fill="none" />`;
        
        // Casas
        for(let i=0; i<12; i++) {
            const angulo = (i * 30) * (Math.PI/180); 
            const x2 = cx + r * Math.cos(angulo);
            const y2 = cy + r * Math.sin(angulo);
            svg += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#222" stroke-width="1" />`;
            
            const signoIdx = dados.casas[i].signoInfo.index;
            const fatiaAngulo = (i * 30 + 15 + 180) * (Math.PI/180); // +180 para alinhar Asc à esquerda
            const tx = cx + (r*0.88) * Math.cos(fatiaAngulo);
            const ty = cy + (r*0.88) * Math.sin(fatiaAngulo);
            svg += `<text x="${tx}" y="${ty}" text-anchor="middle" dominant-baseline="middle" fill="#d4af37" font-size="16" font-family="serif">${SIMBOLOS[signoIdx]}</text>`;
            
            const hx = cx + (r*0.2) * Math.cos(fatiaAngulo);
            const hy = cy + (r*0.2) * Math.sin(fatiaAngulo);
            svg += `<text x="${hx}" y="${hy}" text-anchor="middle" dominant-baseline="middle" fill="#555" font-size="9">${i+1}</text>`;
        }

        // Planetas
        dados.planetas.forEach((p, idx) => {
            const grauAsc = (dados.ascendente.index * 30) + dados.ascendente.grauNoSigno;
            let grauRelativo = p.graus - grauAsc;
            if(grauRelativo < 0) grauRelativo += 360;
            const anguloRad = (grauRelativo + 180) * (Math.PI/180);
            const distR = (r*0.55) + ((idx % 3) * 15);
            const px = cx + distR * Math.cos(anguloRad);
            const py = cy + distR * Math.sin(anguloRad);
            const icons = {"Sol":"☉","Lua":"☽","Mercúrio":"☿","Vênus":"♀","Marte":"♂","Júpiter":"♃","Saturno":"♄","Urano":"♅","Netuno":"♆","Plutão":"♇"};
            svg += `<text x="${px}" y="${py}" text-anchor="middle" dominant-baseline="middle" fill="#fff" font-size="14" style="filter: drop-shadow(0 0 2px #000); cursor:help;">${icons[p.nome]}</text>`;
        });

        svg += `</svg>`;
        document.getElementById('chart-area').innerHTML = svg;
    }

    // --- FIREBASE ---
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
        if(user){
            db.collection("usuarios").doc(user.uid).get().then(doc => {
                const d = doc.exists ? doc.data() : {};
                
                const status = (d.status || "").toLowerCase();
                const plano = (d.plano || "").toLowerCase();

                // PERMISSÃO
                if(status !== "premium" && plano !== "premium") {
                    window.location.href = 'dashboard.html';
                    return;
                }

                // DADOS
                const nome = d.nome || "Iniciado";
                const data = d.dataNascimento || d.nascimento || "2000-01-01";
                const hora = d.horaNascimento || d.hora || "12:00";
                const cidade = d.cidade || d.Cidade || "Brasília";
                const estado = d.estado || d.uf || "DF";
                
                renderizar(nome, data, hora, cidade, estado);

            }).catch(e => {
                console.error(e);
                window.location.href = 'index.html';
            });
        } else {
            window.location.href = 'index.html';
        }
    });
</script>
</body>
</html>