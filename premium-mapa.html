<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Mapa Astral</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="auth-guard.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --card-bg: #0a0a0a; }
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; padding-bottom: 100px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        .header-title { font-family: 'Cinzel'; color: var(--gold); text-align: center; margin-top: 40px; font-size: 2.5em; }
        .header-sub { text-align: center; color: #888; margin-bottom: 50px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 2px; }

        .astro-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px; }
        .astro-card { background: radial-gradient(circle, #111 0%, #000 100%); border: 1px solid var(--gold); padding: 20px; border-radius: 8px; text-align: center; }
        .astro-icon { font-size: 2.5em; color: var(--gold); margin-bottom: 10px; }
        .astro-label { color: #888; font-size: 0.8em; text-transform: uppercase; letter-spacing: 1px; }
        .astro-value { font-family: 'Cinzel'; font-size: 1.5em; color: #fff; margin-top: 5px; }

        .report-section { display: flex; flex-direction: column; gap: 30px; }
        .report-block { background: var(--card-bg); padding: 30px; border-left: 4px solid var(--gold); border-bottom: 1px solid #222; }
        .report-block h3 { margin: 0 0 15px 0; color: var(--gold); font-family: 'Cinzel'; font-size: 1.4em; }
        .report-block p { line-height: 1.8; color: #ccc; text-align: justify; }

        .btn-float { position: fixed; bottom: 30px; right: 30px; background: var(--gold); color: #000; padding: 15px 35px; border-radius: 50px; font-family: 'Cinzel'; font-weight: bold; cursor: pointer; border: none; z-index: 100; font-size: 1.1em; }
        .btn-back { cursor: pointer; color: #888; text-transform: uppercase; font-size: 0.8em; margin-bottom: 20px; display: inline-block; }

        @media print { .btn-float, .btn-back { display: none !important; } body { background: #fff; color: #000; } .astro-card, .report-block { border: 1px solid #000; background: #fff; color: #000; } .header-title, .astro-value, .report-block h3 { color: #000; } }
        @media(max-width: 600px) { .astro-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div onclick="window.location.href='dashboard-premium.html'" class="btn-back">← VOLTAR AO HUB</div>
    
    <h1 class="header-title">MAPA ASTRAL</h1>
    <div class="header-sub" id="user-info">...</div>

    <div class="astro-grid">
        <div class="astro-card">
            <div class="astro-icon"><i class="fas fa-sun"></i></div>
            <div class="astro-label">Signo Solar</div>
            <div class="astro-value" id="val-sol">...</div>
        </div>
        <div class="astro-card">
            <div class="astro-icon"><i class="fas fa-moon"></i></div>
            <div class="astro-label">Signo Lunar</div>
            <div class="astro-value" id="val-lua">...</div>
        </div>
        <div class="astro-card">
            <div class="astro-icon"><i class="fas fa-arrow-up"></i></div>
            <div class="astro-label">Ascendente</div>
            <div class="astro-value" id="val-asc">...</div>
        </div>
    </div>

    <div class="report-section" id="report-area"></div>
</div>

<button class="btn-float" onclick="window.print()"><i class="fas fa-file-pdf"></i> SALVAR MAPA</button>

<script>
    // --- 1. MOTOR ASTROLÓGICO EMBUTIDO ---
    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    
    const TEXTOS_ASTRO = {
        "sol": "O Sol representa sua essência, seu ego e a força vital. É quem você é na raiz.",
        "lua": "A Lua rege suas emoções, instintos e o que te faz sentir seguro.",
        "asc": "O Ascendente é a máscara que você usa, sua primeira impressão e aparência física."
    };

    function getSignoSolar(dia, mes) {
        if((mes == 3 && dia >= 21) || (mes == 4 && dia <= 19)) return "Áries";
        if((mes == 4 && dia >= 20) || (mes == 5 && dia <= 20)) return "Touro";
        if((mes == 5 && dia >= 21) || (mes == 6 && dia <= 20)) return "Gêmeos";
        if((mes == 6 && dia >= 21) || (mes == 7 && dia <= 22)) return "Câncer";
        if((mes == 7 && dia >= 23) || (mes == 8 && dia <= 22)) return "Leão";
        if((mes == 8 && dia >= 23) || (mes == 9 && dia <= 22)) return "Virgem";
        if((mes == 9 && dia >= 23) || (mes == 10 && dia <= 22)) return "Libra";
        if((mes == 10 && dia >= 23) || (mes == 11 && dia <= 21)) return "Escorpião";
        if((mes == 11 && dia >= 22) || (mes == 12 && dia <= 21)) return "Sagitário";
        if((mes == 12 && dia >= 22) || (mes == 1 && dia <= 19)) return "Capricórnio";
        if((mes == 1 && dia >= 20) || (mes == 2 && dia <= 18)) return "Aquário";
        return "Peixes";
    }

    // Estimativa de Ascendente (Simplificada baseada na hora e signo solar)
    function getAscendenteEstimado(signoSolar, hora) {
        if(!hora) return "Indefinido";
        const idxSolar = SIGNOS.indexOf(signoSolar);
        const h = parseInt(hora.split(':')[0]);
        // A cada 2h o ascendente muda +1 signo a partir do solar (aprox nascer do sol as 6h)
        // Se nasceu as 6h, Asc = Sol.
        const offset = Math.floor((h - 6) / 2); 
        let idxAsc = (idxSolar + offset) % 12;
        if(idxAsc < 0) idxAsc += 12;
        return SIGNOS[idxAsc];
    }

    // Calculadora de Fase Lunar (Algoritmo Conway)
    function getFaseLunar(date) {
        let year = date.getFullYear(); let month = date.getMonth() + 1; let day = date.getDate();
        if (month < 3) { year--; month += 12; } ++month;
        let c = 365.25 * year; let e = 30.6 * month;
        let jd = c + e + day - 694039.09; jd /= 29.5305882;
        let b = parseInt(jd); jd -= b; b = Math.round(jd * 8);
        if (b >= 8) b = 0;
        const fases = ["Nova", "Crescente", "Quarto Crescente", "Crescente Gibosa", "Cheia", "Minguante Gibosa", "Quarto Minguante", "Minguante"];
        return fases[b];
    }

    function executarMapa(dataNasc, horaNasc, nome) {
        document.getElementById('user-info').innerText = `${nome} | ${dataNasc} às ${horaNasc || '12:00'}`;
        
        const [ano, mes, dia] = dataNasc.split('-').map(Number);
        const dataObj = new Date(ano, mes-1, dia);
        
        const sol = getSignoSolar(dia, mes);
        const asc = getAscendenteEstimado(sol, horaNasc);
        const luaFase = getFaseLunar(dataObj); // Lua por fase, não signo exato (requer efemérides complexas)

        document.getElementById('val-sol').innerText = sol;
        document.getElementById('val-lua').innerText = `Lua ${luaFase}`; 
        document.getElementById('val-asc').innerText = asc;

        const area = document.getElementById('report-area');
        area.innerHTML = `
            <div class="report-block">
                <h3>SOL EM ${sol.toUpperCase()}</h3>
                <p>O Sol é o centro do seu mapa. Em <strong>${sol}</strong>, sua essência brilha através de características como ${getKeywords(sol)}. Este é o combustível da sua alma.</p>
            </div>
            <div class="report-block">
                <h3>ASCENDENTE EM ${asc.toUpperCase()}</h3>
                <p>O Ascendente é como o mundo te vê. Com este posicionamento, sua primeira impressão é marcada pela energia de <strong>${asc}</strong>. É a máscara social e o estilo físico.</p>
            </div>
            <div class="report-block">
                <h3>LUA NA FASE ${luaFase.toUpperCase()}</h3>
                <p>Nascido sob a Lua ${luaFase}, suas emoções seguem este ciclo. ${getDescLua(luaFase)}</p>
            </div>
        `;
    }

    function getKeywords(signo) {
        const k = { "Áries":"coragem e iniciativa", "Touro":"estabilidade e prazer", "Gêmeos":"comunicação e curiosidade", "Câncer":"emoção e proteção", "Leão":"criatividade e nobreza", "Virgem":"ordem e serviço", "Libra":"harmonia e justiça", "Escorpião":"intensidade e transformação", "Sagitário":"liberdade e sabedoria", "Capricórnio":"ambição e disciplina", "Aquário":"inovação e fraternidade", "Peixes":"compaixão e sonho" };
        return k[signo] || "energia única";
    }
    
    function getDescLua(fase) {
        if(fase.includes("Nova")) return "Momento de inícios e sementes. Você é intuitivo e reservado.";
        if(fase.includes("Crescente")) return "Energia de ação e crescimento. Você busca progresso constante.";
        if(fase.includes("Cheia")) return "O ápice da luminosidade. Você é expressivo e carismático.";
        return "Tempo de reflexão e sabedoria. Você carrega uma alma antiga.";
    }

    // --- 2. CONEXÃO SEGURA ---
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
        if (!user) {
            executarMapa("2000-01-01", "12:00", "Visitante");
        } else {
            db.collection("usuarios").doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();
                    executarMapa(d.dataNascimento || "2000-01-01", d.horaNascimento || "12:00", d.nome || "Iniciado");
                }
            });
        }
    });
</script>
</body>
</html>