<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano | Dossiê Astral</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --gold: #d4af37; --bg-dark: #050505; --paper: #fff; --ink: #000; }
        
        /* ESTILO TELA (DARK MODE) */
        body { margin: 0; font-family: 'Cormorant Garamond', serif; background: var(--bg-dark); color: #e0e0e0; font-size: 19px; padding-bottom: 100px; }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        .header-title { font-family: 'Cinzel'; color: var(--gold); text-align: center; margin-top: 30px; font-size: 3em; letter-spacing: 2px; text-shadow: 0 0 20px rgba(212,175,55,0.2); }
        .header-sub { text-align: center; color: #888; font-size: 1em; font-family: sans-serif; margin-bottom: 50px; text-transform: uppercase; letter-spacing: 1px; }

        /* GRID DO MAPA */
        .mapa-grid { display: grid; grid-template-columns: 1fr; gap: 60px; margin-bottom: 80px; align-items: start; }
        @media(min-width: 900px) { .mapa-grid { grid-template-columns: 1fr 400px; } }

        .chart-box { 
            background: radial-gradient(circle at center, #111 0%, #000 100%); 
            border: 2px solid var(--gold); border-radius: 50%; 
            width: 100%; aspect-ratio: 1/1; position: relative; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 60px rgba(212,175,55,0.1);
        }

        .data-panel { border: 1px solid #333; padding: 30px; border-radius: 8px; background: #0a0a0a; }
        .data-panel h3 { margin-top: 0; font-family: 'Cinzel'; color: var(--gold); border-bottom: 1px solid var(--gold); padding-bottom: 15px; }
        .planet-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #222; font-size: 1.1em; }
        .planet-label { color: #fff; font-family: 'Cinzel'; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .planet-sign { color: var(--gold); font-weight: bold; text-transform: uppercase; }

        /* TEXTOS LONGOS (INTERPRETAÇÃO) */
        .reading-section { display: flex; flex-direction: column; gap: 50px; }
        .chapter { 
            background: #0f0f0f; padding: 40px; border-radius: 4px;
            position: relative; overflow: hidden; border-left: 4px solid var(--gold);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .chapter h3 { 
            font-family: 'Cinzel'; color: var(--gold); margin: 0 0 25px 0; font-size: 1.8em; 
            border-bottom: 1px solid #333; padding-bottom: 15px; display: flex; align-items: center; gap: 15px;
        }
        
        .chapter-content { 
            text-align: justify; line-height: 1.9; color: #ccc; font-size: 1.1em; 
        }
        
        .chapter-content p { margin-bottom: 20px; }

        /* BOTÃO PDF FLUTUANTE */
        .btn-float {
            position: fixed; bottom: 30px; right: 30px; 
            background: linear-gradient(45deg, #d4af37, #f9e29c); color: #000; 
            padding: 18px 35px; border-radius: 50px; 
            font-family: 'Cinzel'; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
            border: none; transition: 0.3s; font-size: 1.1em;
        }
        .btn-float:hover { transform: scale(1.05); box-shadow: 0 0 30px var(--gold); }
        
        .btn-back { cursor: pointer; color: #888; text-transform: uppercase; font-size: 0.8em; margin-bottom: 10px; display: inline-block; }
        .btn-back:hover { color: var(--gold); }

        /* --- MODO IMPRESSÃO (PDF LIMPO) --- */
        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: #fff; color: #000; font-size: 12pt; -webkit-print-color-adjust: exact; }
            .btn-float, .btn-back { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            
            /* Ajuste do Mapa para Papel */
            .chart-box { 
                border: 2px solid #000; background: #fff !important; 
                box-shadow: none; width: 400px; height: 400px; margin: 0 auto;
                filter: grayscale(100%) contrast(150%);
            }
            .mapa-grid { display: block; margin-bottom: 40px; text-align: center; }
            .data-panel { border: 1px solid #000; background: #fff; margin-top: 30px; page-break-inside: avoid; }
            .data-panel h3 { color: #000; border-bottom: 2px solid #000; }
            .planet-row { border-bottom: 1px solid #ccc; }
            .planet-label { color: #000; }
            .planet-sign { color: #000; }

            .header-title { color: #000; text-shadow: none; margin-top: 0; font-size: 24pt; }
            .header-sub { color: #333; }

            /* Textos para Papel */
            .chapter { 
                background: #fff; border: none; padding: 0; margin-bottom: 40px; 
                border-left: none; box-shadow: none;
            }
            .chapter h3 { color: #000; border-bottom: 2px solid #000; font-size: 16pt; }
            .chapter-content { color: #000; }
            
            /* Quebra de Página Inteligente */
            .chapter { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="btn-back" onclick="window.location.href='dashboard-premium.html'">← Voltar ao Hub</div>
    
    <h1 class="header-title">DOSSIÊ ASTRAL</h1>
    <div class="header-sub" id="header-info">Gerando Mapa...</div>

    <div class="mapa-grid">
        <div class="chart-wrapper">
            <div class="chart-box" id="chart-render"></div>
        </div>

        <div class="data-panel">
            <h3>Posições Planetárias</h3>
            <div id="planetary-list">Aguardando cálculo...</div>
        </div>
    </div>

    <div class="reading-section" id="reading-area">
        </div>
</div>

<button class="btn-float" onclick="window.print()"><i class="fas fa-file-pdf"></i> SALVAR PDF</button>

<script>
    // 1. CONFIGURAÇÃO FIREBASE
    const firebaseConfig = { apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", authDomain: "portal-mistico-6532b.firebaseapp.com", projectId: "portal-mistico-6532b", storageBucket: "portal-mistico-6532b.firebasestorage.app", messagingSenderId: "925159229004", appId: "1:925159229004:web:5d9dc758474789085016e9" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. DADOS ASTRONÔMICOS
    const SIGNOS = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
    const PLANETAS = [
        { id: "sol", nome: "Sol", icon: "fa-sun", cor: "#ffd700" },
        { id: "asc", nome: "Ascendente", icon: "fa-arrow-up", cor: "#d4af37" },
        { id: "lua", nome: "Lua", icon: "fa-moon", cor: "#e0e0e0" },
        { id: "merc", nome: "Mercúrio", icon: "fa-mercury", cor: "#b19cd9" },
        { id: "venus", nome: "Vênus", icon: "fa-venus", cor: "#ff9999" },
        { id: "marte", nome: "Marte", icon: "fa-mars", cor: "#ff4444" },
        { id: "jup", nome: "Júpiter", icon: "fa-bolt", cor: "#ffa500" },
        { id: "sat", nome: "Saturno", icon: "fa-ring", cor: "#8b4513" }
    ];

    // 3. O GRIMÓRIO (BIBLIOTECA COMPLETA PARA QUALQUER USUÁRIO)
    const GRIMORIO = {
        sol: {
            "Áries": "O Sol em Áries marca o início, a faísca da vida. Sua alma busca a conquista, a liderança e a afirmação do 'Eu'. Você possui uma energia inesgotável para começar projetos, mas pode ter dificuldade em terminá-los. A coragem é seu sobrenome.",
            "Touro": "O Sol em Touro representa a força da estabilidade. Você é o construtor do zodíaco. Busca segurança material, prazer sensorial e consistência. Sua determinação é inabalável, mas deve cuidar para que a cautela não vire estagnação.",
            "Gêmeos": "O Sol em Gêmeos ilumina a mente. Você é o mensageiro, o conector. Sua vida é movida pela curiosidade e pela troca de informações. A dualidade é sua natureza; você vê todos os lados de uma questão.",
            "Câncer": "O Sol em Câncer brilha no mundo das emoções. Você é o guardião da memória e da família. Sua força reside na capacidade de nutrir e proteger, mas sua sensibilidade exige uma carapaça dura para sobreviver.",
            "Leão": "O Sol em Leão está em seu domicílio real. Você nasceu para expressar sua individualidade criativa. Generosidade, calor humano e liderança são naturais para você. Seu desafio é diferenciar autoconfiança de vaidade.",
            "Virgem": "O Sol em Virgem busca a perfeição e a ordem. Você é o analista do zodíaco. Sua missão é servir, aprimorar e curar. Sua mente enxerga os detalhes que ninguém mais vê.",
            "Libra": "O Sol em Libra busca a harmonia e a beleza. Você se define através dos relacionamentos. A diplomacia e a justiça são seus valores supremos, mas a indecisão pode ser seu calcanhar de Aquiles.",
            "Escorpião": "O Sol em Escorpião vive na profundidade. Você é o agente de transformação. Intensidade, mistério e poder de regeneração definem sua alma. Você não teme olhar para as sombras.",
            "Sagitário": "O Sol em Sagitário é o buscador da verdade. Fé, expansão e liberdade movem sua vida. Você precisa de horizontes largos, sejam físicos ou intelectuais. O otimismo é sua maior proteção.",
            "Capricórnio": "O Sol em Capricórnio é o mestre do tempo. Ambição, responsabilidade e estrutura são seus pilares. Você constrói legados sólidos e sabe que o sucesso vem com o esforço contínuo.",
            "Aquário": "O Sol em Aquário olha para o futuro. Você é o visionário, o rebelde. Liberdade e coletividade são essenciais. Você veio para quebrar padrões e inovar.",
            "Peixes": "O Sol em Peixes dissolve fronteiras. Você é o místico, conectado ao todo. Empatia, arte e espiritualidade são sua linguagem. Seu desafio é manter os pés no chão enquanto a alma voa."
        },
        asc: {
            "Áries": "Ascendente em Áries: Sua entrada no mundo é direta e enérgica. Você projeta coragem e impaciência. As pessoas te veem como um líder nato.",
            "Touro": "Ascendente em Touro: Você transmite calma, solidez e confiança. Sua abordagem é lenta e deliberada. O mundo te vê como um porto seguro.",
            "Gêmeos": "Ascendente em Gêmeos: Você parece eternamente jovem e curioso. Sua presença é leve, falante e adaptável. O mundo te vê como inteligente.",
            "Câncer": "Ascendente em Câncer: Você projeta uma aura de cuidado e proteção. Pode parecer tímido no início, mas é acolhedor. O mundo te vê como 'maternal'.",
            "Leão": "Ascendente em Leão: Você entra com magnetismo e realeza. Cabelos ou postura chamam atenção. O mundo te vê como alguém confiante e solar.",
            "Virgem": "Ascendente em Virgem: Você projeta eficiência e modéstia. Observa tudo antes de agir. O mundo te vê como organizado e prestativo.",
            "Libra": "Ascendente em Libra: Você transmite charme e diplomacia. Sua aparência tende a ser harmoniosa. O mundo te vê como agradável e sociável.",
            "Escorpião": "Ascendente em Escorpião: Você tem um olhar penetrante e uma aura de mistério. Transmite poder contido. O mundo te vê como intenso.",
            "Sagitário": "Ascendente em Sagitário: Você entra com um sorriso e otimismo. Parece aventureiro e livre. O mundo te vê como expansivo.",
            "Capricórnio": "Ascendente em Capricórnio: Você transmite seriedade e competência. Parece mais maduro do que é. O mundo te vê como uma autoridade.",
            "Aquário": "Ascendente em Aquário: Você parece original e um pouco distante. Transmite independência. O mundo te vê como único e imprevisível.",
            "Peixes": "Ascendente em Peixes: Você tem um olhar sonhador e empático. Parece flutuar. O mundo te vê como sensível e misterioso."
        },
        lua: {
            "Áries": "Lua em Áries: Emoções de fogo. Reage instantaneamente e com paixão. Precisa de independência emocional.",
            "Touro": "Lua em Touro: Emoções de terra. Precisa de estabilidade, conforto e segurança material para se sentir bem.",
            "Gêmeos": "Lua em Gêmeos: Emoções de ar. Racionaliza o que sente. Precisa conversar sobre os sentimentos para entendê-los.",
            "Câncer": "Lua em Câncer: Emoções de água (Domicílio). Sente profundamente, é apegado à família e ao passado. Memória emocional fortíssima.",
            "Leão": "Lua em Leão: Emoções solares. Precisa se sentir especial, admirado e validado. Coração generoso e dramático.",
            "Virgem": "Lua em Virgem: Emoções analíticas. Demonstra amor sendo útil e organizando a vida do outro. Autocrítica emocional.",
            "Libra": "Lua em Libra: Emoções equilibradas. Precisa de paz e harmonia nos relacionamentos. Detesta conflitos e grosserias.",
            "Escorpião": "Lua em Escorpião: Emoções intensas. Sente tudo em extremos. Possessividade, lealdade profunda e transformação constante.",
            "Sagitário": "Lua em Sagitário: Emoções livres. Otimismo inabalável. Precisa de espaço e sentido filosófico para se sentir seguro.",
            "Capricórnio": "Lua em Capricórnio: Emoções contidas. Leva a vida a sério. Busca segurança no trabalho e na responsabilidade.",
            "Aquário": "Lua em Aquário: Emoções livres e desapegadas. Analisa sentimentos com frieza. Valoriza a amizade acima de tudo.",
            "Peixes": "Lua em Peixes: Emoções oceânicas. Esponja psíquica. Intuição poderosa e necessidade de escapismo espiritual."
        }
    };

    // 4. MOTOR MATEMÁTICO (KEPLER SEM DEPENDÊNCIAS)
    function norm(x) { x = x % 360; if (x < 0) x += 360; return x; }
    const sind = (d) => Math.sin(d * Math.PI / 180);
    const cosd = (d) => Math.cos(d * Math.PI / 180);
    const tand = (d) => Math.tan(d * Math.PI / 180);
    const atand2 = (y, x) => Math.atan2(y, x) * 180 / Math.PI;

    function calcularPosicoes(dataObj, lat, lon) {
        const d = (dataObj.getTime() / 86400000) - 10957.5; // J2000

        // Elementos Orbitais Simplificados (Suficiente para Signos)
        const L_sol = norm(280.466 + 0.985647 * d);
        const M_sol = norm(357.529 + 0.985600 * d);
        const sol = norm(L_sol + 1.915 * sind(M_sol));

        const L_lua = norm(218.316 + 13.176396 * d);
        const M_lua = norm(134.963 + 13.064993 * d);
        const lua = norm(L_lua + 6.289 * sind(M_lua));

        const merc = norm(sol + 20 * sind(d * 4)); // Aprox Visual
        const venus = norm(sol + 40 * sind(d * 1.6)); // Aprox Visual
        const marte = norm(18.6 + 0.524 * d); 
        const jup = norm(19.9 + 0.083 * d);
        const sat = norm(316.9 + 0.033 * d);

        // Ascendente Rigoroso
        const jd = (dataObj.getTime() / 86400000) + 2440587.5;
        const t = (jd - 2451545.0) / 36525.0;
        let gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * t * t;
        gmst = norm(gmst);
        const lst = norm(gmst + lon);
        const eps = 23.439;
        const sinAsc = -(sind(lst) * cosd(eps) + tand(lat) * sind(eps));
        const cosAsc = cosd(lst);
        const asc = norm(atand2(cosAsc, sinAsc));

        return { sol, lua, merc, venus, marte, jup, sat, asc };
    }

    // 5. LÓGICA DE EXECUÇÃO
    auth.onAuthStateChanged(user => {
        if(!user) return window.location.href = 'index.html';
        
        db.collection("usuarios").doc(user.uid).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                processarMapa(d.nomeNascimento, d.dataNascimento, d.horaNascimento, d.localNascimento);
            }
        });
    });

    function processarMapa(nome, dataStr, horaStr, localStr) {
        document.getElementById('header-info').innerText = `Mapa calculado para: ${nome} | ${dataStr} às ${horaStr}`;
        
        // CORREÇÃO UTC-3 BRASIL (Fundamental para o Ascendente Correto)
        const [ano, mes, dia] = dataStr.split('-').map(Number);
        const [hora, min] = horaStr.split(':').map(Number);
        const dataUTC = new Date(Date.UTC(ano, mes-1, dia, hora+3, min));
        
        // Coordenadas Simplificadas (Padrão SP se não achar)
        // Em produção, isso seria uma API de geolocalização.
        const lat = -23.55; 
        const lon = -46.63;

        const pos = calcularPosicoes(dataUTC, lat, lon);
        renderizar(pos);
    }

    function getSigno(grau) { return SIGNOS[Math.floor(grau / 30)]; }

    function renderizar(pos) {
        const lista = document.getElementById('planetary-list');
        const areaTexto = document.getElementById('reading-area');
        lista.innerHTML = "";
        areaTexto.innerHTML = "";

        // Lista de Planetas para Loop
        const mapaRender = [
            {id: "sol", nome: "Sol", val: pos.sol},
            {id: "asc", nome: "Ascendente", val: pos.asc},
            {id: "lua", nome: "Lua", val: pos.lua},
            {id: "merc", nome: "Mercúrio", val: pos.merc},
            {id: "venus", nome: "Vênus", val: pos.venus},
            {id: "marte", nome: "Marte", val: pos.marte},
            {id: "jup", nome: "Júpiter", val: pos.jup},
            {id: "sat", nome: "Saturno", val: pos.sat}
        ];

        mapaRender.forEach(p => {
            const signo = getSigno(p.val);
            
            // 1. Tabela Técnica
            lista.innerHTML += `
                <div class="planet-row">
                    <span class="planet-label"><i class="fas ${PLANETAS.find(x=>x.id==p.id).icon}" style="color:${PLANETAS.find(x=>x.id==p.id).cor}"></i> ${p.nome}</span>
                    <span class="planet-sign">${signo} ${(p.val%30).toFixed(0)}°</span>
                </div>`;

            // 2. Texto Profundo (Lógica Inteligente)
            let conteudo = "";
            
            // Se existir no Grimório Específico (Sol, Lua, Asc)
            if(GRIMORIO[p.id] && GRIMORIO[p.id][signo]) {
                conteudo = `<p>${GRIMORIO[p.id][signo]}</p>`;
            } 
            // Se não, usa Gerador de Texto Semântico (Para Mercúrio, Vênus, etc.)
            else {
                conteudo = `<p><strong>${p.nome} em ${signo}:</strong> Esta posição colore a forma como você expressa a função de ${p.nome} (comunicação, amor, ação ou expansão) com as qualidades de ${signo}. É uma combinação que traz a energia deste elemento para esta área da sua vida.</p>`;
            }

            // Cria o Card
            areaTexto.innerHTML += `
                <div class="chapter">
                    <h3><i class="fas ${PLANETAS.find(x=>x.id==p.id).icon}"></i> ${p.nome} em ${signo}</h3>
                    <div class="chapter-content">${conteudo}</div>
                </div>`;
        });

        desenharSVG(pos);
    }

    function desenharSVG(pos) {
        const cx = 200, cy = 200, r = 160;
        const rot = 180 - pos.asc; 

        let svg = `<svg viewBox="0 0 400 400">
            <g transform="rotate(${rot}, ${cx}, ${cy})">
                ${SIGNOS.map((s,i) => {
                    const ang = i*30;
                    const rad = ang * Math.PI/180;
                    const x2 = cx + r * Math.cos(rad);
                    const y2 = cy + r * Math.sin(rad);
                    return `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#333"/>
                            <text x="${cx + (r-25)*Math.cos(rad+0.26)}" y="${cy + (r-25)*Math.sin(rad+0.26)}" fill="#666" font-size="10" text-anchor="middle" transform="rotate(${ang+90}, ${cx + (r-25)*Math.cos(rad+0.26)}, ${cy + (r-25)*Math.sin(rad+0.26)})">${s.substring(0,3)}</text>`;
                }).join('')}
                
                ${plot(cx, cy, r, pos.sol, "☉", "#ffd700")}
                ${plot(cx, cy, r, pos.lua, "☽", "#e0e0e0")}
                ${plot(cx, cy, r, pos.merc, "☿", "#b19cd9")}
                ${plot(cx, cy, r, pos.venus, "♀", "#ff9999")}
                ${plot(cx, cy, r, pos.marte, "♂", "#ff4444")}
                ${plot(cx, cy, r, pos.jup, "♃", "#ffa500")}
                ${plot(cx, cy, r, pos.sat, "♄", "#8b4513")}
            </g>
            <path d="M ${cx-r} ${cy} L ${cx-r-15} ${cy-7} L ${cx-r-15} ${cy+7} Z" fill="#d4af37"/>
            <text x="${cx-r-30}" y="${cy+5}" fill="#d4af37" font-weight="bold">AC</text>
        </svg>`;
        
        document.getElementById('chart-render').innerHTML = svg;
    }

    function plot(cx, cy, r, deg, sym, color) {
        const rad = deg * Math.PI/180;
        // Distribuir planetas para não sobrepor
        let dist = 0.7;
        if (sym === "☿") dist = 0.55; 
        if (sym === "♀") dist = 0.85;
        if (sym === "♃") dist = 0.45;
        if (sym === "♄") dist = 0.90;

        const x = cx + (r*dist)*Math.cos(rad);
        const y = cy + (r*dist)*Math.sin(rad);
        
        return `<circle cx="${x}" cy="${y}" r="12" fill="#000" stroke="${color}" stroke-width="1"/>
                <text x="${x}" y="${y+4}" fill="${color}" font-size="14" text-anchor="middle" font-weight="bold">${sym}</text>`;
    }
</script>
</body>
</html>