<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyDMeLgPB2wroI-papk-T9R_mbCcj3MC2TE", 
        authDomain: "portal-mistico-6532b.firebaseapp.com", 
        projectId: "portal-mistico-6532b", 
        storageBucket: "portal-mistico-6532b.firebasestorage.app", 
        messagingSenderId: "925159229004", 
        appId: "1:925159229004:web:5d9dc758474789085016e9" 
    };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const auth = firebase.auth();
    const db = firebase.firestore();

    auth.onAuthStateChanged(user => {
        if (user) {
            verificarPermissao(user.uid);
        } else {
            window.location.href = "index.html";
        }
    });

    async function verificarPermissao(uid) {
        try {
            const doc = await db.collection("usuarios").doc(uid).get();
            if (doc.exists) {
                const data = doc.data();
                const status = (data.status || "").toLowerCase();
                const plano = (data.plano || "").toLowerCase();

                // --- TRAVA DE SEGURANÇA ---
                // Se NÃO for premium, chuta para o painel gratuito
                if (status !== "premium" && plano !== "premium") {
                    alert("Acesso restrito a Iniciados Premium.");
                    window.location.href = "dashboard.html"; 
                    return; 
                }

                // Se passou, carrega os dados
                if (data.dataNascimento) {
                    const signo = getSigno(data.dataNascimento);
                    const numerologia = getNumerologia(data.dataNascimento);
                    const ascendente = getAscendenteEstimado(data.horaNascimento, signo);

                    setText('user-signo', signo);
                    setText('user-numerologia', numerologia);
                    setText('user-ascendente', ascendente);
                } else {
                    setText('user-signo', "Indefinido");
                }
                
                // Libera a tela
                document.getElementById('loading').style.display = 'none';

            } else {
                window.location.href = "index.html";
            }
        } catch (error) {
            console.error(error);
            window.location.href = "index.html";
        }
    }

    function setText(id, text) {
        const el = document.getElementById(id);
        if(el) el.innerText = text;
    }

    // --- FUNÇÕES DE CÁLCULO ---
    function getSigno(dateString) {
        const date = new Date(dateString + "T12:00:00");
        const day = date.getDate();
        const month = date.getMonth() + 1;
        if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "Aquário";
        if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "Peixes";
        if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "Áries";
        if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "Touro";
        if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "Gêmeos";
        if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "Câncer";
        if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "Leão";
        if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "Virgem";
        if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "Libra";
        if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "Escorpião";
        if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "Sagitário";
        if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return "Capricórnio";
        return "Indefinido";
    }

    function getNumerologia(dateString) {
        let str = dateString.replace(/\D/g, '');
        let sum = 0;
        for(let char of str) sum += parseInt(char);
        while(sum > 9 && sum !== 11 && sum !== 22) {
            let tempStr = sum.toString();
            let tempSum = 0;
            for(let char of tempStr) tempSum += parseInt(char);
            sum = tempSum;
        }
        return sum;
    }

    function getAscendenteEstimado(timeString, signoSolar) {
        if(!timeString) return "Desconhecido";
        const signos = ["Áries", "Touro", "Gêmeos", "Câncer", "Leão", "Virgem", "Libra", "Escorpião", "Sagitário", "Capricórnio", "Aquário", "Peixes"];
        const [hora, min] = timeString.split(':').map(Number);
        const indexSolar = signos.indexOf(signoSolar);
        let diff = hora - 6;
        let casas = Math.floor(diff / 2);
        let indexAsc = (indexSolar + casas) % 12;
        if (indexAsc < 0) indexAsc += 12;
        return signos[indexAsc];
    }
</script>